<!DOCTYPE html>
<html lang="en" class="govuk-template">
<head>
  <meta name="generator" content="HTML Tidy for HTML5 for Linux version 5.8.0">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Vibe planning</title><!-- Base URL script to handle both local and GitHub Pages environments -->

  <script>
        // Determine the base URL for assets
        (function() {
            // This function sets a global baseUrl variable that can be used throughout the application
            window.baseUrl = '';
            
            // Get the current path
            var path = window.location.pathname;
            
            // Check if we're on GitHub Pages (or any non-root deployment)
            // Extract the base part of the path (everything before the last directory)
            var pathParts = path.split('/');
            if (pathParts.length > 2) {
                // Remove the last part (assuming it's index.html or empty)
                pathParts.pop();
                // Join the remaining parts to form the base URL
                window.baseUrl = pathParts.join('/');
                // If we're at the root of a directory, baseUrl might end up empty
                if (window.baseUrl === '') {
                    window.baseUrl = '/';
                } else if (!window.baseUrl.endsWith('/')) {
                    window.baseUrl += '/';
                }
            } else {
                window.baseUrl = '/';
            }
            
            console.log('Base URL detected:', window.baseUrl);
        })();
  </script><!-- GOV.UK Design System -->
  <link rel="stylesheet" href="assets/govuk/govuk-frontend.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css">
  <link href='https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/leaflet.fullscreen.css' rel='stylesheet' />
  <style>
        body {
            margin: 0;
            padding: 0;
            /* Using GOV.UK font family instead */
        }
        
        #map-container {
            position: relative;
            width: 100%;
            height: 100vh;
            margin-bottom: 30px;
            margin-top: 30px;
            border: 2px solid #0b0c0c;
        }
        
        #map {
            position: absolute;
            width: 100%;
            height: 100%;
            left: 0;
            top: 0;
        }
        
        .control-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background-color: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            max-width: 250px;
        }
        
        .control-title {
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .control-item {
            margin-bottom: 15px;
        }
        
        .color-picker {
            width: 40px;
            height: 25px;
            padding: 0;
            border: none;
            margin-left: 5px;
            vertical-align: middle;
        }
        
        label {
            display: inline-block;
            margin-bottom: 5px;
        }
        
        input[type="range"] {
            width: 100%;
        }
        
        .coverage-value {
            font-weight: bold;
        }
        
        .file-input {
            margin-bottom: 10px;
        }
        
        /* Use GOV.UK button classes instead of custom styles */
        button {
            /* These styles are only applied to buttons without govuk-button class */
            padding: 10px 15px;
            background-color: #00703c;
            color: white;
            border: none;
            border-radius: 0;
            cursor: pointer;
            margin-top: 5px;
            font-family: arial, sans-serif;
            font-weight: 400;
            font-size: 16px;
            line-height: 1.1875;
            box-shadow: 0 2px 0 #002d18;
            text-align: center;
        }
        
        button:hover {
            background-color: #005a30;
        }
        
        .legend {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid #ddd;
        }
        
        .legend-item {
            margin-bottom: 5px;
        }
        
        .legend-color {
            display: inline-block;
            width: 15px;
            height: 15px;
            margin-right: 5px;
            vertical-align: middle;
        }
        
        /* Compact radio buttons to fit on a single line */
        .govuk-radios--inline-compact {
            display: flex;
            flex-wrap: nowrap;
            overflow-x: auto;
            white-space: nowrap;
            padding-bottom: 10px;
        }
        
        .govuk-radios--inline-compact .govuk-radios__item {
            margin-right: 10px;
            margin-bottom: 0;
            font-size: 14px;
        }
        
        .govuk-radios--inline-compact .govuk-radios__label {
            padding: 3px 5px;
            font-size: 14px;
            line-height: 1.2;
        }
        
        /* GOV.UK style for leaflet popups */
        .leaflet-popup-content-wrapper {
            border-radius: 0;
            padding: 0;
            box-shadow: 0 5px 10px rgba(0,0,0,.1);
        }
        
        .leaflet-popup-content {
            margin: 0;
            padding: 15px;
            font-family: arial, sans-serif;
            font-size: 16px;
            line-height: 1.5;
        }
        
        .leaflet-popup-content table {
            border-collapse: collapse;
            width: 100%;
        }
        
        .leaflet-popup-content th {
            text-align: left;
            font-weight: 700;
            padding: 5px 10px 5px 0;
            vertical-align: top;
            width: 40%;
        }
        
        .leaflet-popup-content td {
            padding: 5px 0;
            vertical-align: top;
        }
        
        .leaflet-popup-tip {
            background: #00703c;
        }
        
        /* Animation styles */
        @keyframes pulse {
            0% { transform: scale(1); background-color: transparent; }
            25% { transform: scale(1.4); background-color: #00703c; }
            50% { transform: scale(1.6); background-color: #00703c; }
            75% { transform: scale(1.4); background-color: #00703c; }
            100% { transform: scale(1); background-color: transparent; }
        }
        
        .pulse {
            animation: pulse 1s ease-in-out;
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: bold;
        }
        
        /* Achievement styles for each category */
        .goal-achieved {
            background-color: #00703c !important; /* GOV.UK green */
            color: white !important; /* White text for better contrast on green */
            font-weight: bold;
            padding: 3px 8px;
            border-radius: 4px;
            transition: all 0.3s ease;
        }
        
        /* No specific outline styles for goal achievement */
        
        /* Goal celebration */
        #celebration-banner {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background-color: #00703c;
            color: white;
            text-align: center;
            padding: 15px;
            z-index: 9999;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            transition: transform 0.5s ease-in-out;
            transform: translateY(-100%);
        }
        
        #celebration-banner.show {
            display: block;
            transform: translateY(0);
        }
        
        #confetti-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9998;
        }
        
        /* AI Feedback Modal Styles */
        #ai-feedback-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            overflow-y: auto;
        }
        
        #ai-feedback-content {
            position: relative;
            background-color: #f3f2f1;
            margin: 5% auto;
            padding: 30px;
            width: 70%;
            max-width: 800px;
            border-radius: 5px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            font-family: arial, sans-serif;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        #ai-feedback-close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 24px;
            cursor: pointer;
            color: #505a5f;
        }
        
        #ai-feedback-title {
            color: #1d70b8;
            border-left: 5px solid #1d70b8;
            padding-left: 15px;
            margin-bottom: 25px;
        }
        
        .ai-feedback-section {
            margin-bottom: 20px;
        }
        
        .ai-feedback-list {
            background-color: white;
            padding: 20px;
            border-left: 4px solid;
            margin-bottom: 15px;
        }
        
        .ai-feedback-list.improvements {
            border-color: #d4351c;
        }
        
        .ai-feedback-list.positives {
            border-color: #00703c;
        }
        
        .ai-feedback-list h3 {
            margin-top: 0;
            margin-bottom: 15px;
        }
        
        .ai-feedback-list ul {
            margin-bottom: 0;
        }
        
        .ai-feedback-list li {
            margin-bottom: 8px;
        }
        
        /* AI typing effect */
        .typing-effect {
            overflow: hidden;
            white-space: nowrap;
            margin: 0;
            letter-spacing: 0.1em;
            animation: typing 3.5s steps(40, end);
            max-width: 100%;
        }
        
        @keyframes typing {
            from { width: 0 }
            to { width: 100% }
        }
        
        .fade-in {
            opacity: 0;
            animation: fadeIn ease 2s forwards;
            animation-delay: var(--delay, 0s);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        #ai-button {
            padding: 12px 25px;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            display: inline-flex;
            align-items: center;
            box-shadow: 0 4px 12px rgba(76, 44, 146, 0.3);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        #ai-button::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(60deg, transparent, rgba(255,255,255,0.2), transparent);
            transform: rotate(30deg);
            transition: 0.5s;
            opacity: 0;
        }
        
        #ai-button:hover {
            background: linear-gradient(135deg, #003078 70%, #2e1a58 100%);
            box-shadow: 0 6px 16px rgba(76, 44, 146, 0.4);
        }
        
        #ai-button:hover::after {
            left: 100%;
            opacity: 1;
        }
        
        #ai-button svg {
            margin-right: 10px;
            width: 24px;
            height: 24px;
            filter: drop-shadow(0 0 2px rgba(255, 255, 255, 0.6));
        }
        
        /* AI Suggestion Button Styles */
        #ai-buttons-container {
            display: flex;
            gap: 20px;
            margin: 20px 0 40px 0;
        }
        
        #ai-suggestion-button {
        }
        
        #ai-suggestion-button::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(60deg, transparent, rgba(255,255,255,0.2), transparent);
            transform: rotate(30deg);
            transition: 0.5s;
            opacity: 0;
        }
        
        #ai-suggestion-button:hover {
            background: linear-gradient(135deg, #00582e 70%, #2e1a58 100%);
            box-shadow: 0 6px 16px rgba(0, 112, 60, 0.4);
        }
        
        #ai-suggestion-button:hover::after {
            left: 100%;
            opacity: 1;
        }
        
        #ai-suggestion-button svg {
            margin-right: 10px;
            width: 24px;
            height: 24px;
            filter: drop-shadow(0 0 2px rgba(255, 255, 255, 0.6));
        }
        
        /* AI Plan Suggestion Modal Styles */
        #ai-suggestion-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            overflow-y: auto;
        }
        
        #ai-suggestion-content {
            position: relative;
            background-color: #f3f2f1;
            margin: 5% auto;
            padding: 30px;
            width: 70%;
            max-width: 800px;
            border-radius: 5px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            font-family: arial, sans-serif;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        #ai-suggestion-close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 24px;
            cursor: pointer;
            color: #505a5f;
        }
        
        #ai-suggestion-title {
            color: #00703c;
            border-left: 5px solid #00703c;
            padding-left: 15px;
            margin-bottom: 25px;
        }
        
        .ai-suggestion-section {
            margin-bottom: 20px;
        }
        
        .suggested-plan-details {
            background-color: white;
            padding: 20px;
            border-left: 4px solid #00703c;
            margin-bottom: 15px;
        }
        
        .plan-comparison {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin: 20px 0;
        }
        
        .plan-stat {
            flex: 1;
            min-width: 200px;
            background-color: white;
            padding: 15px;
            border-radius: 4px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        
        .plan-stat h4 {
            margin-top: 0;
            margin-bottom: 10px;
            border-bottom: 2px solid #f3f2f1;
            padding-bottom: 5px;
        }
        
        .plan-action-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
        }
        
        /* Original Local Plan Modal Styles */
        #original-plan-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            overflow-y: auto;
        }
        
        #original-plan-content {
            position: relative;
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            width: 80%;
            max-width: 1000px;
            border-radius: 5px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            font-family: arial, sans-serif;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        #original-plan-close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 24px;
            cursor: pointer;
            color: #505a5f;
        }
        
        #original-plan-title {
            color: #1d70b8;
            margin-bottom: 25px;
        }
  </style>
</head>
<body class="govuk-template__body">
  <script>
  document.body.className = ((document.body.className) ? document.body.className + ' js-enabled' : 'js-enabled');
  </script> <!-- Celebration elements -->
  <div id="celebration-banner" role="alert">
    <h2 class="govuk-heading-m govuk-!-margin-bottom-1">Goal Achieved!</h2>
    <p class="govuk-body">You've successfully found land for 1,000 homes for your community. Well done!</p>
  </div>
  <canvas id="confetti-canvas"></canvas><!-- AI Feedback Modal -->
  <div id="ai-feedback-modal">
    <div id="ai-feedback-content">
      <span id="ai-feedback-close" onclick="closeAiFeedback()">×</span>
      <h2 id="ai-feedback-title" class="govuk-heading-l typing-effect">AI Plan Analysis</h2>
      <div class="ai-feedback-section">
        <p class="govuk-body fade-in" style="--delay: 1s;">After analyzing your current plan, I've evaluated how it balances different interests and needs within the development area.</p>
        <p class="govuk-body fade-in" style="--delay: 2s;">Overall, your plan shows a good attempt at balancing various planning priorities. Here's my detailed assessment:</p>
      </div>
      <div class="ai-feedback-list improvements fade-in" style="--delay: 3.5s;">
        <h3 class="govuk-heading-m">Areas for Improvement</h3>
        <ul class="govuk-list govuk-list--bullet">
          <li>Housing is farther than the national average from schools, which may create accessibility issues for families</li>
          <li>Commercial space is too focused in one area and should be spread out to create multiple neighborhood centers</li>
          <li>Large areas focused solely on housing puts pressure on public services</li>
          <li>Green space connectivity could be improved to create wildlife corridors</li>
          <li>Some built-up areas appear to encroach on flood-prone zones</li>
        </ul>
      </div>
      <div class="ai-feedback-list positives fade-in" style="--delay: 5s;">
        <h3 class="govuk-heading-m">Positive Aspects</h3>
        <ul class="govuk-list govuk-list--bullet">
          <li>Good overall housing density that meets development targets</li>
          <li>Effective preservation of most green belt areas</li>
          <li>Sensible placement of GP practices relative to population density</li>
          <li>Mixed-use development in central areas promotes walkability</li>
          <li>Retail spaces are generally accessible from residential areas</li>
        </ul>
      </div>
      <div class="ai-feedback-section fade-in" style="--delay: 6.5s;">
        <p class="govuk-body">Consider making adjustments to address the identified issues while maintaining the strengths of your current plan.</p>
        <p class="govuk-body">This analysis is based on standard planning best practices and may not account for all local factors.</p>
      </div>
    </div>
  </div><!-- AI Suggestion Modal -->
  <div id="ai-suggestion-modal">
    <div id="ai-suggestion-content">
      <span id="ai-suggestion-close" onclick="closeAiSuggestion()">×</span>
      <h2 id="ai-suggestion-title" class="govuk-heading-l typing-effect">AI proposal</h2>
      <div class="ai-suggestion-section">
        <p class="govuk-body fade-in" style="--delay: 1s;">I've generated an alternative layout that optimizes your plan by grouping similar categories together. This creates more efficient zones and improves access to services.</p>
      </div>
      <div class="suggested-plan-details fade-in" style="--delay: 2s;">
        <h3 class="govuk-heading-m">Features of this proposal:</h3>
        <ul class="govuk-list govuk-list--bullet">
          <li><strong>Clustered Housing:</strong> Housing areas are grouped together with nearby amenities</li>
          <li><strong>Distributed Commercial:</strong> Retail and employment spaces are spread across multiple smaller hubs</li>
          <li><strong>Strategic Services:</strong> Schools and GP practices are positioned at optimal distances between housing clusters</li>
          <li><strong>Green Belt Preservation:</strong> Green belt areas maintained with improved ecological connectivity</li>
          <li><strong>Built-up Area Management:</strong> Development concentrated in appropriate zones</li>
        </ul>
      </div>
      <div class="fade-in" style="--delay: 3s;">
        <h3 class="govuk-heading-m">Comparison to the emerging plan:</h3>
        <div class="plan-comparison">
          <div class="plan-stat">
            <h4>Housing</h4>
            <p>Same number of homes but in more efficient clusters with better access to services</p>
          </div>
          <div class="plan-stat">
            <h4>Commercial</h4>
            <p>Equal space distributed across 3 neighborhood centers instead of 1 concentrated area</p>
          </div>
          <div class="plan-stat">
            <h4>Services</h4>
            <p>Schools and GP practices relocated to serve more residents within shorter distances</p>
          </div>
        </div>
      </div>
      <div class="plan-action-buttons fade-in" style="--delay: 4s;">
        <button class="govuk-button" onclick="applyAiSuggestion()">Use this proposal</button> <button class="govuk-button govuk-button--secondary" onclick="closeAiSuggestion()">Use this proposal</button>
      </div>
    </div>
  </div><!-- Original Local Plan Modal -->
  <div id="original-plan-modal">
    <div id="original-plan-content">
      <span id="original-plan-close" onclick="closeOriginalPlan()">×</span>
      <h2 id="original-plan-title" class="govuk-heading-l">Emerging Local Plan</h2>
      <div class="govuk-grid-row">
        <div class="govuk-grid-column-two-thirds">
          <div class="govuk-panel govuk-panel--confirmation">
            <h3 class="govuk-panel__title">Local Plan 2025-2040</h3>
            <div class="govuk-panel__body">
              Strategic development framework for sustainable growth
            </div>
          </div>
          <h3 class="govuk-heading-m govuk-!-margin-top-6">Development Strategy</h3>
          <p class="govuk-body">The Local Plan provides a clear framework for future growth and development across the area up to 2038. It aims to meet the identified needs for new homes, jobs and infrastructure, while protecting the area's valuable natural and built environment.</p>
          <div class="govuk-inset-text">
            <p>The plan allocates land for 10,000 new homes, 500,000 sqm of employment space, and supporting infrastructure including schools, healthcare facilities, and transport improvements.</p>
          </div>
          <h3 class="govuk-heading-m">Key Development Principles</h3>
          <ul class="govuk-list govuk-list--bullet">
            <li>Focus development in and around existing urban centers to maximize sustainability</li>
            <li>Protect green belt land while allowing strategic releases where necessary</li>
            <li>Create mixed-use neighborhoods with good access to services</li>
            <li>Provide a range of housing types and tenures to meet diverse needs</li>
            <li>Deliver employment opportunities alongside residential development</li>
            <li>Ensure timely provision of infrastructure to support new growth</li>
          </ul>
        </div>
        <div class="govuk-grid-column-one-third">
          <div class="govuk-!-padding-5" style="background-color: #f3f2f1;">
            <h3 class="govuk-heading-s">Housing</h3>
            <p class="govuk-body-s">10,000 new homes across the plan period</p>
            <h3 class="govuk-heading-s">Employment</h3>
            <p class="govuk-body-s">500,000 sqm of commercial and retail space</p>
            <h3 class="govuk-heading-s">Education</h3>
            <p class="govuk-body-s">5 new primary schools and 1 secondary school</p>
            <h3 class="govuk-heading-s">Healthcare</h3>
            <p class="govuk-body-s">3 new GP practices and extended hospital facilities</p>
            <h3 class="govuk-heading-s">Green Space</h3>
            <p class="govuk-body-s">20% of development area reserved for green space</p>
          </div>
        </div>
      </div>
      <div class="govuk-!-margin-top-6">
        <button class="govuk-button" onclick="applyOriginalPlan()">Apply Emerging Plan</button> <button class="govuk-button govuk-button--secondary" onclick="closeOriginalPlan()">Close</button>
      </div>
    </div>
  </div><a href="#main-content" class="govuk-skip-link">Skip to main content</a>
  <header class="govuk-header" role="banner" data-module="govuk-header">
    <div class="govuk-header__container govuk-width-container"></div>
  </header>
  <div class="govuk-width-container">
    <main class="govuk-main-wrapper" id="main-content">
          <div class="govuk-notification-banner" role="region" aria-labelledby="govuk-notification-banner-title" data-module="govuk-notification-banner">
  <div class="govuk-notification-banner__header">
    <h2 class="govuk-notification-banner__title" id="govuk-notification-banner-title">
        Notice
    </h2>
  </div>
  <div class="govuk-notification-banner__content">
    <p class="govuk-notification-banner__heading">
    This is a prototype
    </p>
      <details class="govuk-details">
        <summary class="govuk-details__summary">
          <span class="govuk-details__summary-text">About this prototype</span>
        </summary>
        <div class="govuk-details__text">
          <p class="govuk-body">This prototype was originally created for the "transforming public engagement" challenge at the <a href="https://github.com/i-dot-ai/local-gov-hack">Local Government Hackday</a>, April 30 to May 1 2025.</p>
          <ul class="govuk-list govuk-list--bullet">
            <li>How could a local plan consultation be different in the age of open source and AI?</li>
            <li>Could we enable to community to play with the plan, contributing ideas, rather than just commenting on a plan proposed by planners.</li>
            <li>Could people use AI to help them generate better policies and site allocations?</li>
            <li>Maybe "vibe planning" could transform public consultations and make local plans faster!</li>
          </ul>
          <p class="govuk-body">The team built a <a href="hackathon.html">working prototype</a> in less than a day using Kirklees as an example using hyperthetical housing targets.</p><img src="assets/hackathon.png" style="max-width: 100vw; max-height: 75vh; border: 2px solid black" alt="Screenshot of the prototype">
          <p class="govuk-body"></p>
          <figcaption>
            Screenshot of the prototype <a href="hackathon.html">as demonstrated at the hackathon</a>.
          </figcaption>
          <p class="govuk-body">The code behind this prototype is open source available on <a href="https://github.com/digital-land/vibe-planning/">GitHub</a>. We expect to develop the prototype further to help people understand the idea, and build similar applications using the <a href="https://www.planning.data.gov.uk">Planning Data</a> platform.</p>
        </div>
      </details>
  </div>
</div>
      <h1 class="govuk-heading-l">Local plan consultation</h1>
      <p class="govuk-body">We need houses for our growing population, more school places for the next generation, and space for businesses to create jobs for our community.</p><!-- Scenario & Goals Section -->
      <div class="govuk-panel govuk-!-margin-bottom-6" style="background-color: #f3f2f1; color: #0b0c0c;">
        <div class="govuk-grid-row govuk-!-margin-top-0">
          <!-- Development Needs -->
          <div class="govuk-grid-column-one-half">
            <div class="govuk-!-text-align-left">
              <h3 class="govuk-heading-m">Development</h3>
              <ul class="govuk-list govuk-body">
                <li><strong>1000</strong> new homes, 200 of which will be affordable</li>
                <li><strong>14,000 sq m</strong> of new employment and retail space</li>
              </ul>
            </div>
          </div><!-- Infrastructure Needs -->
          <div class="govuk-grid-column-one-half">
            <div class="govuk-!-text-align-left">
              <h3 class="govuk-heading-m">Infrastructure</h3>
              <ul class="govuk-list govuk-body">
                <li><strong>1</strong> new primary school</li>
                <li><strong>1</strong> new GP practice</li>
                <li>Capacity for <strong>1,500</strong> new car journeys</li>
                <li><strong>16,000 sq m</strong> of parks (10% of space)</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
      <details class="govuk-details">
        <summary class="govuk-details__summary">
          <span class="govuk-details__summary-text">About these targets</span>
        </summary>
        <div class="govuk-details__text">
          <p class="govuk-body">These are hyperthetical housing and other targets for one year.</p>
        </div>
      </details>
      <p class="govuk-body">Have your say on where these new homes and businesses should be built.</p>
      <div>
        <hr class="govuk-section-break govuk-section-break--l govuk-section-break--visible">

        <fieldset class="govuk-fieldset">
              <legend class="govuk-fieldset__legend govuk-fieldset__legend--l">
              <h3 class="govuk-fieldset__heading govuk-!-margin-bottom-4">
                  Choose a proposal
              </h3></legend>
              <label class="govuk-label" for="sort">Use the official emerging local plan</label> <button id="original-plan-button" class="govuk-button govuk-button--secondary" onclick="showOriginalPlan()">Emerging local plan</button>
          <div class="govuk-form-group">
            <label class="govuk-label" for="sort">Choose a proposal submitted by the community</label> <select class="govuk-select" id="sort" name="sort">
              <option value="published">
                Recently published
              </option>
              <option value="updated" selected>
                Recently updated
              </option>
              <option value="views">
                Most views
              </option>
              <option value="comments">
                Most comments
              </option>
            </select>
          </div><label class="govuk-label" for="sort">Or chat with our AI to create a new proposal</label> <button id="ai-suggestion-button" class="govuk-button" onclick="showAiSuggestion()">Vibe with our AI</button>
        </fieldset>
      </div>
      <hr class="govuk-section-break govuk-section-break--l govuk-section-break--visible">
      <h1 class="govuk-heading-l">Improve the proposal</h1>
      <div class="govuk-panel govuk-!-margin-bottom-6" style="background-color: #f3f2f1; color: #0b0c0c;">
        <div class="govuk-grid-row govuk-!-margin-top-0">
          <!-- Overall Progress Bar -->
          <div class="govuk-grid-row">
            <div class="govuk-grid-column-full">
              <div class="govuk-inset-text govuk-!-margin-top-2 govuk-!-margin-bottom-0 govuk-!-padding-4" style="background-color: #1d70b8; color: white;">
                <p class="govuk-heading-m govuk-!-margin-bottom-0" style="color: white;">Overall Progress: <span id="progress-percentage" style="color: white;">0</span>%</p>
              </div>
            </div>
          </div><!-- All Statistics in One Line -->
          <div class="govuk-grid-row govuk-!-margin-top-4 govuk-!-margin-bottom-6">
            <div class="govuk-grid-column-one-quarter">
              <div class="govuk-!-padding-top-0">
                <p class="govuk-body govuk-!-margin-bottom-0">Housing</p>
                <div class="govuk-inset-text govuk-!-margin-top-2 govuk-!-margin-bottom-0 govuk-!-padding-top-2 govuk-!-padding-bottom-2">
                  <p class="govuk-heading-l govuk-!-margin-bottom-0" style="color: #1d70b8;"><span id="houses-count">0</span></p>
                  <p class="govuk-body-s govuk-!-margin-bottom-0">homes of 1,000</p>
                </div>
              </div>
            </div>
            <div class="govuk-grid-column-one-quarter">
              <div class="govuk-!-padding-top-0">
                <p class="govuk-body govuk-!-margin-bottom-0">Retail & Employment</p>
                <div class="govuk-inset-text govuk-!-margin-top-2 govuk-!-margin-bottom-0 govuk-!-padding-top-2 govuk-!-padding-bottom-2">
                  <p class="govuk-heading-l govuk-!-margin-bottom-0" style="color: #942514;"><span id="retail-count">0</span></p>
                  <p class="govuk-body-s govuk-!-margin-bottom-0">sq m of 14,000</p>
                </div>
              </div>
            </div>
            <div class="govuk-grid-column-one-quarter">
              <div class="govuk-!-padding-top-0">
                <p class="govuk-body govuk-!-margin-bottom-0">Primary Schools</p>
                <div class="govuk-inset-text govuk-!-margin-top-2 govuk-!-margin-bottom-0 govuk-!-padding-top-2 govuk-!-padding-bottom-2">
                  <p class="govuk-heading-l govuk-!-margin-bottom-0" style="color: #28a197;"><span id="school-count">0</span></p>
                  <p class="govuk-body-s govuk-!-margin-bottom-0">of 1 required</p>
                </div>
              </div>
            </div>
            <div class="govuk-grid-column-one-quarter">
              <div class="govuk-!-padding-top-0">
                <p class="govuk-body govuk-!-margin-bottom-0">GP Practices</p>
                <div class="govuk-inset-text govuk-!-margin-top-2 govuk-!-margin-bottom-0 govuk-!-padding-top-2 govuk-!-padding-bottom-2">
                  <p class="govuk-heading-l govuk-!-margin-bottom-0" style="color: #5694ca;"><span id="gp-count">0</span></p>
                  <p class="govuk-body-s govuk-!-margin-bottom-0">of 1 required</p>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div id="map-container" class="govuk-!-margin-top-4">
          <div id="map"></div>
        </div>
        <div class="govuk-!-margin-top-6">
          <div class="govuk-width-container">
            <div class="govuk-form-group">
              <div class="govuk-checkboxes govuk-checkboxes--small govuk-checkboxes--inline">
                <div class="govuk-checkboxes__item">
                  <input class="govuk-checkboxes__input" id="toggle-green-belt" name="toggle-green-belt" type="checkbox" checked onchange="toggleGreenBelt(this.checked)"> <label class="govuk-label govuk-checkboxes__label" for="toggle-green-belt"><strong>Exclude the Green Belt</strong></label>
                </div>
                <div class="govuk-checkboxes__item">
                  <input class="govuk-checkboxes__input" id="toggle-built-up" name="toggle-built-up" type="checkbox" onchange="toggleBuiltUpAreas(this.checked)"> <label class="govuk-label govuk-checkboxes__label" for="toggle-built-up"><strong>Exclude built-up areas</strong></label>
                </div>
              </div>
            </div><!-- Category Selection Toolbar -->
            <div class="govuk-form-group govuk-!-margin-top-4">
              <fieldset class="govuk-fieldset">
                <h3 class="govuk-heading-s"><legend class="govuk-fieldset__legend govuk-fieldset__legend--s">Select category to apply</legend></h3>
                <div class="govuk-radios govuk-radios--small govuk-radios--inline govuk-radios--inline-compact" id="category-selector">
                  <div class="govuk-radios__item">
                    <input class="govuk-radios__input" id="category-housing" name="selected-category" type="radio" value="housing" checked> <label class="govuk-label govuk-radios__label" for="category-housing">Housing</label>
                  </div>
                  <div class="govuk-radios__item">
                    <input class="govuk-radios__input" id="category-commercial" name="selected-category" type="radio" value="commercial"> <label class="govuk-label govuk-radios__label" for="category-commercial">Retail and Employment</label>
                  </div>
                  <div class="govuk-radios__item">
                    <input class="govuk-radios__input" id="category-non-green-belt" name="selected-category" type="radio" value="non-green-belt"> <label class="govuk-label govuk-radios__label" for="category-non-green-belt">Non-Green Belt</label>
                  </div>
                  <div class="govuk-radios__item">
                    <input class="govuk-radios__input" id="category-green-belt" name="selected-category" type="radio" value="green-belt"> <label class="govuk-label govuk-radios__label" for="category-green-belt">Green Belt</label>
                  </div>
                </div>
              </fieldset>
            </div>
          </div>
        </div>
      </div>
      <hr class="govuk-section-break govuk-section-break--l govuk-section-break--visible">
      <h1 class="govuk-heading-l">Submit your proposal</h1>
      <div class="govuk-width-container govuk-!-margin-top-6 govuk-!-margin-bottom-6">
        <form id="plan-submit-form" class="govuk-form-group" autocomplete="off" style="max-width: 700px" name="plan-submit-form">
          <h2 class="govuk-heading-m">Explain your proposal</h2>
          <div class="govuk-hint">
            Help people understand why your proposal is better than the current plan
          </div>
          <textarea class="govuk-textarea" id="plan-explanation" name="plan-explanation" rows="5" style="margin-bottom: 20px;"></textarea>
          <div class="govuk-button-group">
            <button type="submit" class="govuk-button">Submit your proposal</button>
          </div>
        </form>
      </div>
      <div class="govuk-grid-column-two-thirds" style="background-color: #f3f2f1; color: #0b0c0c;">
        <h2 class="govuk-heading-m">What happens next</h2>
        <p class="govuk-body">Your proposal will be visible for other people to see, and use to create their own proposals.</p>
        <p class="govuk-body">All proposals will be reviewed by our planners and used to inform the emerging local plan.</p>
        <p class="govuk-body">The final plan will be submitted for examination by the Planning Inspectorate before being adopted.</p>
      </div>
    </main>
  </div><!-- Leaflet JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script> <!-- GOV.UK JavaScript -->
  <script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/Leaflet.fullscreen.min.js'></script>
  <script>

        // Initialize the map with doubleClickZoom disabled
        const map = L.map('map', {
            fullscreenControl: true,
            doubleClickZoom: false // Disable double click zoom completely
        }).setView([0, 0], 2);
        
        // Add base layers
        const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: ' OpenStreetMap contributors'
        }).addTo(map);
        
        const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            maxZoom: 19,
            attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
        });
        
        // Add layer control
        const baseLayers = {
            "OpenStreetMap": osm,
            "Satellite": satellite
        };
        
        L.control.layers(baseLayers).addTo(map);
        
        // Initialize variables
        let gridLayer = null;
        let gridData = null;
        let highlightEnabled = true;
        let hideGreenBelt = true; // Default to hiding green belt
        let showBuiltUpAreas = false; // Default to not show built-up areas
        let selectedCategory = 'housing'; // Default selected category
        let selectedFeatureIds = []; // Store selected feature IDs
        
        // Setup event listener for category selection
        document.addEventListener('DOMContentLoaded', function() {
            // Set up category selection radio buttons
            const categoryRadios = document.querySelectorAll('input[name="selected-category"]');
            categoryRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    selectedCategory = this.value;
                    console.log('Selected category:', selectedCategory);
                });
            });
            
            // Default select the housing option
            document.getElementById('category-housing').checked = true;
        });
        
        // Get DOM elements
        const thresholdSlider = document.getElementById('coverage-threshold');
        const thresholdValue = document.getElementById('threshold-value');
        const highlightColorPicker = document.getElementById('highlight-color');
        const defaultColorPicker = document.getElementById('default-color');
        const toggleButton = document.getElementById('toggle-highlight');
        const fileInput = document.getElementById('geojson-file');
        
        // Helper to get fill color by status
        function getFillColor(status) {
            switch(status) {
                case 'green-belt': return "#00703c";
                case 'non-green-belt': return "#ffdd00"; // Changed to GOV.UK yellow for better visibility
                case 'housing': return "#1d70b8";
                case 'commercial': return "#942514";
                default: return "#ffdd00"; // Default also changed to match non-green-belt
            }
        }
        // Function to style GeoJSON features
        function styleFeature(feature) {
            // Hide green belt areas if toggle is active
            if (hideGreenBelt && feature.properties.status === 'green-belt') {
                return {
                    fillOpacity: 0,
                    opacity: 0,
                    interactive: false // Make these squares non-interactive
                };
            }
            
            // Highlight if selected
            if (selectedFeatureIds && selectedFeatureIds.includes(feature.properties.id)) {
                return {
                    weight: 2,
                    color: '#ffdd00', // Yellow border
                    fillOpacity: 0.9,
                    fillColor: getFillColor(feature.properties.status),
                    opacity: 1
                };
            }
            // Using GOV.UK color palette
            const style = {
                weight: 0.5, // Thinner border for subtlety
                opacity: 0.3, // Lower opacity for subtle borders
                color: '#505a5f', // GOV.UK dark grey for subtle borders
                fillOpacity: 0.7
            };
            
            // Initialize status if it doesn't exist yet
            if (!feature.properties.status) {
                // Set default status based on green-belt value
                if (feature.properties["green-belt"] >= 0.1) {
                    feature.properties.status = 'green-belt';
                } else {
                    feature.properties.status = 'non-green-belt';
                }
            }
            
            // Set color based on status
            switch(feature.properties.status) {
                case 'green-belt':
                    style.fillColor = "#00703c"; // GOV.UK green
                    break;
                case 'non-green-belt':
                    style.fillColor = "#ffdd00"; // GOV.UK yellow - better visibility
                    style.fillOpacity = 0.5; // Slightly transparent to indicate it can be modified
                    break;
                case 'housing':
                    style.fillColor = "#1d70b8"; // GOV.UK blue
                    break;
                case 'commercial':
                    style.fillColor = "#942514"; // GOV.UK red
                    break;
                case 'primary-school':
                    style.fillColor = "#28a197"; // Turquoise for Primary School
                    break;
                case 'gp-practice':
                    style.fillColor = "#5694ca"; // Light blue for GP Practice
                    break;
                default:
                    style.fillColor = "#f3f2f1"; // Default to light grey
            }
            
            // Show built-up areas if toggle is active
            if (showBuiltUpAreas && feature.properties['built-up-area'] > 0) {
                // Use GOV.UK negative red with a pattern
                style.fillColor = "#d4351c"; // GOV.UK negative red
                style.fillOpacity = 0.8;
                style.weight = 1;
                style.opacity = 0.8;
                style.color = "#b10e1e"; // Darker red for the border
                
                // Add proportional opacity based on built-up area percentage
                // Higher built-up areas will be more opaque
                const builtUpPercentage = feature.properties['built-up-area'] / 10000;
                style.fillOpacity = Math.max(0.4, Math.min(0.9, builtUpPercentage));
            }
            
            return style;
        }
        
        // Function to add popup information with controls to change land status
        // --- Prevent any zoom-related actions when shift is held ---
        map.on('dblclick', function(e) {
            if (isShiftDown) {
                e.originalEvent.preventDefault();
                e.originalEvent.stopPropagation();
            }
        });
        
        // Also prevent zoom on single click when shift is down
        map.on('click', function(e) {
            if (isShiftDown) {
                e.originalEvent.preventDefault();
                e.originalEvent.stopPropagation();
                return false;
            }
        });
        function onEachFeature(feature, layer) {
            // Prevent zoom on feature double-click
            layer.on('dblclick', function(e) {
                e.originalEvent.preventDefault();
            });
            
            // Handle click on feature
            layer.on('click', function(e) {
                // Prevent default behaviors
                e.originalEvent.preventDefault();
                e.originalEvent.stopPropagation();
                
                if (isShiftDown) {
                    // Multi-select with shift+click for mass updates
                    if (!selectedFeatureIds.includes(feature.properties.id)) {
                        selectedFeatureIds.push(feature.properties.id);
                    } else {
                        selectedFeatureIds = selectedFeatureIds.filter(id => id !== feature.properties.id);
                    }
                    updateGridLayer(true); // This is a selection update
                    
                    // Show mass update button if >0
                    if (selectedFeatureIds.length > 0) {
                        massUpdateBtn.style.display = 'block';
                    } else {
                        massUpdateBtn.style.display = 'none';
                    }
                } else {
                    // Get the currently selected category from radio buttons
                    const selectedRadio = document.querySelector('input[name="selected-category"]:checked');
                    const newStatus = selectedRadio ? selectedRadio.value : 'non-green-belt';
                    
                    console.log('Applying category:', newStatus, 'to feature:', feature.properties.id);
                    
                    // Find the feature in the original data (to ensure we're updating the source data)
                    if (gridData && gridData.features) {
                        const dataFeature = gridData.features.find(f => f.properties.id === feature.properties.id);
                        if (dataFeature) {
                            // Update the source data feature's status
                            dataFeature.properties.status = newStatus;
                            
                            // Recreate the grid layer to reflect the changes
                            updateGridLayer(true);
                            
                            // Update the houses count if that function exists
                            if (typeof updateHousesCount === 'function') {
                                updateHousesCount();
                            }
                        }
                    }
                }
            });
        }
        
        // Helper function to format status text
        function formatStatus(status) {
            switch(status) {
                case 'green-belt': return 'Green Belt';
                case 'non-green-belt': return 'Non-Green Belt';
                case 'housing': return 'Housing';
                case 'commercial': return 'Commercial';
                default: return status;
            }
        }
        
        // Function to update the status when the user clicks the Update button
        function updateStatus(featureId) {
            // Find the selected radio button
            const selectedRadio = document.querySelector(`input[name="status-${featureId}"]:checked`);
            
            if (selectedRadio) {
                const newStatus = selectedRadio.value;
                
                // Find the feature in the gridData
                const feature = gridData.features.find(f => f.properties.id === featureId);
                
                if (feature) {
                    // Update the feature's status
                    feature.properties.status = newStatus;
                    
                    // Update the map
                    updateGridLayer(true); // This is a selection update
                    
                    // Update the houses count
                    updateHousesCount();
                    
                    // Close the popup
                    map.closePopup();
                }
            }
        }
        
        // Function to count and update the progress for all categories with animation
        function updateHousesCount() {
            // Define constants for each category goal
            const HOUSING_GOAL = 1000;
            const RETAIL_GOAL = 14000;
            const SCHOOL_GOAL = 1;
            const GP_GOAL = 1;
            
            // Define multipliers for each category per grid square
            const housesPerSquare = 10;
            const retailSpacePerSquare = 1000; // 1000 sq m per retail square
            const schoolsPerSquare = 1; // 1 school per square
            const gpPerSquare = 1; // 1 GP practice per square
            
            // Count squares by category
            const housingSquares = gridData.features.filter(feature => 
                feature.properties.status === 'housing'
            ).length;
            
            const retailSquares = gridData.features.filter(feature => 
                feature.properties.status === 'commercial' // 'commercial' is the value for Retail and Employment
            ).length;
            
            const schoolSquares = gridData.features.filter(feature => 
                feature.properties.status === 'primary-school'
            ).length;
            
            const gpSquares = gridData.features.filter(feature => 
                feature.properties.status === 'gp-practice'
            ).length;
            
            // Calculate totals
            const totalHouses = housingSquares * housesPerSquare;
            const totalRetailSpace = retailSquares * retailSpacePerSquare;
            const totalSchools = schoolSquares * schoolsPerSquare;
            const totalGps = gpSquares * gpPerSquare;
            
            // Calculate percentages
            const housingPercentage = Math.min(100, Math.floor((totalHouses / HOUSING_GOAL) * 100));
            const retailPercentage = Math.min(100, Math.floor((totalRetailSpace / RETAIL_GOAL) * 100));
            const schoolPercentage = Math.min(100, Math.floor((totalSchools / SCHOOL_GOAL) * 100));
            const gpPercentage = Math.min(100, Math.floor((totalGps / GP_GOAL) * 100));
            
            // Calculate overall progress (average of all percentages)
            const overallProgress = Math.floor((housingPercentage + retailPercentage + schoolPercentage + gpPercentage) / 4);
            
            // Get DOM elements
            // Key stat elements
            const housesCountElement = document.getElementById('houses-count');
            const retailCountElement = document.getElementById('retail-count');
            const schoolCountElement = document.getElementById('school-count');
            const gpCountElement = document.getElementById('gp-count');
            
            // Overall progress element
            const progressPercentageElement = document.getElementById('progress-percentage');
            
            // Get current displayed values
            const currentHouses = parseInt(housesCountElement.textContent, 10) || 0;
            const currentRetailSpace = parseInt(retailCountElement.textContent, 10) || 0;
            const currentSchools = parseInt(schoolCountElement.textContent, 10) || 0;
            const currentGps = parseInt(gpCountElement.textContent, 10) || 0;
            const currentOverallPercentage = parseInt(progressPercentageElement.textContent, 10) || 0;
            
            // Apply pulse animation to elements that have changed
            if (currentSchools !== totalSchools) {
                schoolCountElement.classList.add('pulse');
            }
            if (currentGps !== totalGps) {
                gpCountElement.classList.add('pulse');
            }
            if (currentHouses !== totalHouses) {
                housesCountElement.classList.add('pulse');
            }
            if (currentRetailSpace !== totalRetailSpace) {
                retailCountElement.classList.add('pulse');
            }
            
            // Animate all counters
            setTimeout(() => {
                // Animate stat counters
                animateCounter(currentHouses, totalHouses, housesCountElement);
                animateCounter(currentRetailSpace, totalRetailSpace, retailCountElement);
                animateCounter(currentSchools, totalSchools, schoolCountElement);
                animateCounter(currentGps, totalGps, gpCountElement);
                
                // Animate Overall Progress
                animateCounter(currentOverallPercentage, overallProgress, progressPercentageElement);
                
                // Check if overall goal is newly met
                if (currentOverallPercentage < 100 && overallProgress >= 100) {
                    celebrateGoalAchieved();
                }
                
                // Remove pulse animation after 1 second
                setTimeout(() => {
                    schoolCountElement.classList.remove('pulse');
                    gpCountElement.classList.remove('pulse');
                    housesCountElement.classList.remove('pulse');
                    retailCountElement.classList.remove('pulse');
                }, 1000);
            }, 100);
            
            // Update styling based on goal status
            // Housing
            if (totalHouses >= HOUSING_GOAL) {
                housesCountElement.classList.add('goal-achieved');
            } else {
                housesCountElement.classList.remove('goal-achieved');
            }
            
            // Retail
            if (totalRetailSpace >= RETAIL_GOAL) {
                retailCountElement.classList.add('goal-achieved');
            } else {
                retailCountElement.classList.remove('goal-achieved');
            }
            
            // Schools
            if (totalSchools >= SCHOOL_GOAL) {
                schoolCountElement.classList.add('goal-achieved');
            } else {
                schoolCountElement.classList.remove('goal-achieved');
            }
            
            // GPs
            if (totalGps >= GP_GOAL) {
                gpCountElement.classList.add('goal-achieved');
            } else {
                gpCountElement.classList.remove('goal-achieved');
            }
        }
        
        // Animate counter from start to end value
        function animateCounter(start, end, element) {
            const duration = 1000; // 1 second animation
            const stepTime = 20;
            const steps = duration / stepTime;
            const increment = (end - start) / steps;
            let current = start;
            let step = 0;
            
            const timer = setInterval(() => {
                step++;
                current += increment;
                
                if (step >= steps) {
                    clearInterval(timer);
                    current = end;
                }
                
                element.textContent = Math.round(current);
            }, stepTime);
        }
        
        // Celebration when goal is achieved
        function celebrateGoalAchieved() {
            // Show the celebration banner with animation
            const banner = document.getElementById('celebration-banner');
            banner.classList.add('show');
            
            // Hide after 5 seconds
            setTimeout(() => {
                banner.classList.remove('show');
            }, 5000);
            
            // Launch confetti
            launchConfetti();
        }
        
        // Confetti animation for celebration
        function launchConfetti() {
            const canvas = document.getElementById('confetti-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            
            // Confetti colors - GOV.UK colors
            const colors = ['#00703c', '#1d70b8', '#f3f2f1', '#ffdd00'];
            
            // Confetti particles
            const confetti = [];
            const confettiCount = 200;
            const gravity = 0.5;
            const terminalVelocity = 5;
            const drag = 0.075;
            
            // Create confetti pieces
            for (let i = 0; i < confettiCount; i++) {
                // Distribute confetti across the top of the screen
                confetti.push({
                    color: colors[Math.floor(Math.random() * colors.length)],
                    dimensions: {
                        x: Math.random() * 10 + 5,
                        y: Math.random() * 4 + 8
                    },
                    position: {
                        x: Math.random() * canvas.width,
                        // Distribute starting positions across the top quarter of the screen
                        y: Math.random() * canvas.height * -0.25
                    },
                    rotation: Math.random() * 2 * Math.PI,
                    scale: Math.random() * 0.8 + 0.2, // More varied sizes
                    velocity: {
                        x: Math.random() * 25 - 12.5,
                        y: Math.random() * 25 + 10 // Higher velocity variation for spreading
                    }
                });
            }
            
            // Animation loop
            let animationFrame = null;
            const render = () => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                let remainingConfetti = 0;
                
                confetti.forEach((confetto, index) => {
                    let width = confetto.dimensions.x * confetto.scale;
                    let height = confetto.dimensions.y * confetto.scale;
                    
                    // Move confetti with gravity and drag
                    confetto.velocity.x -= confetto.velocity.x * drag;
                    confetto.velocity.y = Math.min(confetto.velocity.y + gravity, terminalVelocity);
                    confetto.velocity.x += Math.random() > 0.5 ? Math.random() : -Math.random();
                    
                    confetto.position.x += confetto.velocity.x;
                    confetto.position.y += confetto.velocity.y;
                    confetto.rotation += 0.01;
                    
                    // If confetti is still on screen, render it
                    if (confetto.position.y <= canvas.height) {
                        remainingConfetti++;
                        
                        ctx.save();
                        ctx.translate(confetto.position.x, confetto.position.y);
                        ctx.rotate(confetto.rotation);
                        
                        ctx.fillStyle = confetto.color;
                        ctx.fillRect(-width / 2, -height / 2, width, height);
                        
                        ctx.restore();
                    }
                });
                
                // Continue animation if there's confetti on screen
                if (remainingConfetti > 0) {
                    animationFrame = requestAnimationFrame(render);
                } else {
                    cancelAnimationFrame(animationFrame);
                    // Clean up canvas when done
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                }
            };
            
            // Start animation
            animationFrame = requestAnimationFrame(render);
            
            // Stop confetti after 6 seconds regardless
            setTimeout(() => {
                if (animationFrame) {
                    cancelAnimationFrame(animationFrame);
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                }
            }, 6000);
        }
        
        // Update grid layer
        // Flag to track initial load
        let initialMapLoad = true;
        
        // Function to update the grid layer with current data
        function updateGridLayer(isSelection) {
            if (!gridData) return;
            
            if (gridLayer) {
                map.removeLayer(gridLayer);
            }
            
            // First, prepare a filtered version of the data when hiding green belt
            // This creates a completely new GeoJSON structure without the green belt areas
            let dataToRender = gridData;
            
            if (hideGreenBelt) {
                // Deep clone the data to avoid modifying the original
                dataToRender = JSON.parse(JSON.stringify(gridData));
                // Filter out green belt features entirely
                dataToRender.features = dataToRender.features.filter(feature => 
                    !(feature.properties.status === 'green-belt' || 
                      (feature.properties["green-belt"] >= 0.1 && !feature.properties.status))
                );
            }
            
            // Create a new GeoJSON layer with the current style settings
            gridLayer = L.geoJSON(dataToRender, {
                style: styleFeature,
                onEachFeature: onEachFeature
                // No filter function here - we've already filtered the data
            }).addTo(map);

            // Only fit bounds on initial load (not for selections or updates)
            if (initialMapLoad && !isSelection) {
                map.fitBounds(gridLayer.getBounds());
                initialMapLoad = false;
            }
            
            // Log a message when built-up areas toggle is active
            if (showBuiltUpAreas) {
                console.log('Built-up areas display is active');
            }
        }
        
        // Load GeoJSON data from file
        function loadGeoJSONFile(file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    gridData = JSON.parse(e.target.result);
                    updateGridLayer(false); // Not a selection
                    
                    // Zoom to the data
                    if (gridLayer) {
                        map.fitBounds(gridLayer.getBounds());
                    }
                } catch (error) {
                    console.error("Error parsing GeoJSON:", error);
                    alert("Error loading GeoJSON file. Please check the console for details.");
                }
            };
            
            reader.readAsText(file);
        }

        fetch('boundary/E60000070.geojson')
            .then(response => response.json())
            .then(data => {
                boundaryLayer = L.geoJSON(data, {}).addTo(map);
            })
            .catch(error => console.error('Error loading boundary:', error));
                
        
        // Load the default GeoJSON data
        fetch('grid/E60000070.geojson')
            .then(response => response.json())
            .then(data => {
                gridData = data;
                
                // Initialize the hideGreenBelt flag before first render
                // This ensures the checkbox state matches our hideGreenBelt variable
                hideGreenBelt = document.getElementById('toggle-green-belt').checked;
                
                // Make sure green belt is properly hidden on initial load
                // Force a false parameter to ensure it's not treated as a selection
                updateGridLayer(false);
                
                // Update houses count
                updateHousesCount();
            })
            .catch(error => console.error('Error loading example data:', error));
  </script> <!-- Mass Update Modal -->
  <div id="mass-update-modal" class="govuk-modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.5); z-index:20000; align-items:center; justify-content:center;">
    <div style="background:white; padding:32px; border-radius:8px; min-width:320px; max-width:90vw; margin:auto;">
      <h2 class="govuk-heading-m">Update Category for Selected Boxes</h2>
      <form id="mass-update-form" name="mass-update-form">
        <fieldset class="govuk-fieldset">
          <legend class="govuk-fieldset__legend">Set new category:</legend>
          <div class="govuk-radios govuk-radios--small govuk-radios--inline-compact">
            <div class="govuk-radios__item">
              <input class="govuk-radios__input" id="mass-status-housing" name="mass-status" type="radio" value="housing" checked> <label class="govuk-label govuk-radios__label" for="mass-status-housing">Housing</label>
            </div>
            <div class="govuk-radios__item">
              <input class="govuk-radios__input" id="mass-status-green-belt" name="mass-status" type="radio" value="green-belt"> <label class="govuk-label govuk-radios__label" for="mass-status-green-belt">Green Belt</label>
            </div>
            <div class="govuk-radios__item">
              <input class="govuk-radios__input" id="mass-status-non-green-belt" name="mass-status" type="radio" value="non-green-belt"> <label class="govuk-label govuk-radios__label" for="mass-status-non-green-belt">Non-Green Belt</label>
            </div>
            <div class="govuk-radios__item">
              <input class="govuk-radios__input" id="mass-status-commercial" name="mass-status" type="radio" value="commercial"> <label class="govuk-label govuk-radios__label" for="mass-status-commercial">Retail and Employment</label>
            </div>
            <div class="govuk-radios__item">
              <input class="govuk-radios__input" id="mass-status-primary-school" name="mass-status" type="radio" value="primary-school"> <label class="govuk-label govuk-radios__label" for="mass-status-primary-school">Primary School</label>
            </div>
            <div class="govuk-radios__item">
              <input class="govuk-radios__input" id="mass-status-gp-practice" name="mass-status" type="radio" value="gp-practice"> <label class="govuk-label govuk-radios__label" for="mass-status-gp-practice">GP Practice</label>
            </div>
          </div>
        </fieldset>
        <div style="margin-top:20px;">
          <button type="submit" class="govuk-button govuk-!-margin-right-2">Update Selected</button> <button type="button" class="govuk-button govuk-button--secondary" onclick="closeMassUpdateModal()">Cancel</button>
        </div>
      </form>
    </div>
  </div>
  <script>
    // --- Multi-select state ---
    // selectedFeatureIds is declared globally above
    let isShiftDown = false;

    document.addEventListener('keydown', function(e) {
        if (e.key === 'Shift') {
            isShiftDown = true;
            // Disable zoom when shift is pressed
            map.scrollWheelZoom.disable();
            map.dragging.disable();
            // Also temporarily disable any click zoom
            if (map.options.zoomSnap) {
                map._originalZoomSnap = map.options.zoomSnap;
                map.options.zoomSnap = 0;
            }
        }
    });
    document.addEventListener('keyup', function(e) {
        if (e.key === 'Shift') {
            isShiftDown = false;
            // Re-enable zoom when shift is released
            map.scrollWheelZoom.enable();
            map.dragging.enable();
            // Restore original zoom snap setting
            if (map._originalZoomSnap !== undefined) {
                map.options.zoomSnap = map._originalZoomSnap;
                delete map._originalZoomSnap;
            }
        }
    });

    // --- Add a floating button for mass update ---
    let massUpdateBtn = document.createElement('button');
    massUpdateBtn.innerText = 'Mass Update Category';
    massUpdateBtn.className = 'govuk-button govuk-button--secondary';
    massUpdateBtn.style.position = 'fixed';
    massUpdateBtn.style.bottom = '32px';
    massUpdateBtn.style.right = '32px';
    massUpdateBtn.style.zIndex = 20001;
    massUpdateBtn.style.display = 'none';
    massUpdateBtn.onclick = function() {
        if (selectedFeatureIds.length > 0) openMassUpdateModal();
    };
    document.body.appendChild(massUpdateBtn);

    // --- Modal logic ---
    function openMassUpdateModal() {
        document.getElementById('mass-update-modal').style.display = 'flex';
    }
    function closeMassUpdateModal() {
        document.getElementById('mass-update-modal').style.display = 'none';
        selectedFeatureIds = [];
        updateGridLayer();
        massUpdateBtn.style.display = 'none';
    }
    document.getElementById('mass-update-form').onsubmit = function(e) {
        e.preventDefault();
        const newStatus = document.querySelector('input[name="mass-status"]:checked');
        if (!newStatus) return;
        massUpdateStatus(newStatus.value);
        closeMassUpdateModal();
    };
    // --- Toggle Green Belt function ---
    function toggleGreenBelt(checked) {
        hideGreenBelt = checked;
        updateGridLayer(false); // Not a selection, but a filter change
    }
    // --- Toggle Built-up Areas function ---
    function toggleBuiltUpAreas(checked) {
        showBuiltUpAreas = checked;
        updateGridLayer(false); // Not a selection, but a filter change
    }
    
    // --- Mass update function ---
    function massUpdateStatus(newStatus) {
        if (!gridData) return;
        gridData.features.forEach(f => {
            if (selectedFeatureIds.includes(f.properties.id)) {
                f.properties.status = newStatus;
            }
        });
        updateGridLayer(true); // This is a selection update
        if (typeof updateHousesCount === 'function') updateHousesCount();
    }
    
    // --- AI Feedback functions ---
    function showAiFeedback() {
        // Display the AI feedback modal with animation effects
        const modal = document.getElementById('ai-feedback-modal');
        modal.style.display = 'flex';
        
        // Reset animations for repeated viewing
        document.querySelectorAll('.typing-effect').forEach(el => {
            el.style.animation = 'none';
            el.offsetHeight; // Trigger reflow
            el.style.animation = null;
        });
        
        document.querySelectorAll('.fade-in').forEach(el => {
            el.style.opacity = '0';
            el.offsetHeight; // Trigger reflow
            el.style.animation = null;
        });
    }
    
    function closeAiFeedback() {
        document.getElementById('ai-feedback-modal').style.display = 'none';
    }
    
    // --- AI Plan Suggestion functions ---
    function showAiSuggestion() {
        // Display the AI suggestion modal with animation effects
        const modal = document.getElementById('ai-suggestion-modal');
        modal.style.display = 'flex';
        
        // Reset animations for repeated viewing
        document.querySelectorAll('.typing-effect').forEach(el => {
            el.style.animation = 'none';
            el.offsetHeight; // Trigger reflow
            el.style.animation = null;
        });
        
        document.querySelectorAll('.fade-in').forEach(el => {
            el.style.opacity = '0';
            el.offsetHeight; // Trigger reflow
            el.style.animation = null;
        });
        
        // Reset action buttons if they were changed in a previous attempt
        const planActionButtons = document.querySelector('.plan-action-buttons');
        if (planActionButtons) {
            planActionButtons.innerHTML = `
                <button class="govuk-button" onclick="applyAiSuggestion()">Use this proposal</button>
                <button class="govuk-button govuk-button--secondary" onclick="closeAiSuggestion()">Discard</button>
            `;
        }
    }
    
    function closeAiSuggestion() {
        // Hide the modal
        const modal = document.getElementById('ai-suggestion-modal');
        if (modal) {
            modal.style.display = 'none';
            
            // Make sure we immediately update the map
            if (gridData) {
                console.log('Forcing map refresh after modal close');
                // Use setTimeout to ensure the DOM update happens before we refresh the map
                setTimeout(() => {
                    updateGridLayer(false);
                }, 100);
            }
        }
    }
    
    function applyAiSuggestion() {
        if (!gridData) {
            console.error('No grid data available');
            return;
        }
        
        try {
            console.log('Starting to apply AI suggestion...');
            
            // Store current grid state before making changes
            const previousGridState = JSON.parse(JSON.stringify(gridData));
            
            // Step 1: Reset all statuses
            gridData.features.forEach(feature => {
                // Clear existing status assignments
                feature.properties.status = null;
            });
            
            // Step 2: Create distinct regions based on geographic coordinates
            console.log('Creating optimized plan...');
            createOptimizedPlan(gridData.features);
            
            // Step 3: Update the map with the new plan
            console.log('Updating grid layer and counts...');
            updateGridLayer(false);
            updateHousesCount();
            
            // Show a message in the modal about applying the plan
            const planActionButtons = document.querySelector('.plan-action-buttons');
            planActionButtons.innerHTML = '<p class="govuk-body govuk-!-font-weight-bold">Alternative plan applied successfully!</p>';
            
            // Close the modal after a delay
            setTimeout(() => {
                closeAiSuggestion();
                // Force another update to ensure the map reflects changes
                updateGridLayer(false);
            }, 2000);
            
            console.log('AI suggestion applied successfully');
        } catch (error) {
            console.error('Error applying AI suggestion:', error);
            alert('There was an error applying the AI suggestion. Please try again.');
        }
    }
    
    // Function to create an optimized plan with a coherent spatial allocation
    function createOptimizedPlan(features) {
        // Get geographic bounds of the area
        const bounds = getBounds(features);
        const xRange = bounds.maxX - bounds.minX;
        const yRange = bounds.maxY - bounds.minY;
        
        // Create spatial regions
        const numRegions = 4;
        const regions = [];
        
        // Divide the map into quadrants (creating 4 distinct regions)
        for (let i = 0; i < numRegions; i++) {
            regions.push([]);
        }
        
        // Group features into regions based on their position
        features.forEach(feature => {
            // Use first point of polygon to determine position
            const center = getFeatureCenter(feature);
            
            // Normalize coordinates to 0-1 range
            const xNorm = (center.x - bounds.minX) / xRange;
            const yNorm = (center.y - bounds.minY) / yRange;
            
            // Assign to quadrant (0: top-left, 1: top-right, 2: bottom-left, 3: bottom-right)
            let regionIndex;
            if (xNorm < 0.5) {
                if (yNorm < 0.5) regionIndex = 0;
                else regionIndex = 2;
            } else {
                if (yNorm < 0.5) regionIndex = 1;
                else regionIndex = 3;
            }
            
            regions[regionIndex].push(feature);
        });
        
        // For each region, create a balanced development plan
        regions.forEach((region, idx) => {
            const greenBeltFeatures = [];
            const developableFeatures = [];
            
            // Separate green belt from developable areas
            region.forEach(feature => {
                if (feature.properties['green-belt'] && feature.properties['green-belt'] > 5000) {
                    greenBeltFeatures.push(feature);
                } else {
                    developableFeatures.push(feature);
                }
            });
            
            // Apply zoning to each region (vary the allocation pattern by region)
            applyZoning(developableFeatures, idx);
            
            // Ensure green belt areas are preserved
            greenBeltFeatures.forEach(feature => {
                feature.properties.status = null;
            });
        });
    }
    
    // Apply zoning to a region with different patterns based on region index
    function applyZoning(features, regionIndex) {
        if (features.length === 0) return;
        
        // Sort features based on their position for more coherent zoning
        const sortedFeatures = sortFeaturesByPosition(features, regionIndex);
        
        // Calculate allocations based on developable area
        const totalFeatures = sortedFeatures.length;
        
        // Different regions get different ratios to create distinct neighborhood patterns
        let housingRatio, commercialRatio, schoolRatio, gpRatio;
        
        switch (regionIndex) {
            case 0: // Top-left: Housing-focused with basic services
                housingRatio = 0.75;
                commercialRatio = 0.1;
                schoolRatio = 0.07;
                gpRatio = 0.05;
                break;
            case 1: // Top-right: Mixed use with strong commercial
                housingRatio = 0.45;
                commercialRatio = 0.4;
                schoolRatio = 0.08;
                gpRatio = 0.07;
                break;
            case 2: // Bottom-left: Balanced neighborhood
                housingRatio = 0.6;
                commercialRatio = 0.2;
                schoolRatio = 0.1;
                gpRatio = 0.1;
                break;
            case 3: // Bottom-right: Service-rich area
                housingRatio = 0.55;
                commercialRatio = 0.3;
                schoolRatio = 0.08;
                gpRatio = 0.07;
                break;
        }
        
        // Calculate counts for each category
        const housingCount = Math.max(3, Math.floor(totalFeatures * housingRatio));
        const commercialCount = Math.max(2, Math.floor(totalFeatures * commercialRatio));
        const schoolCount = Math.max(1, Math.floor(totalFeatures * schoolRatio));
        const gpCount = Math.max(1, Math.floor(totalFeatures * gpRatio));
        
        // Create contiguous zones by assigning categories in blocks
        let index = 0;
        
        // Housing zones in contiguous blocks (create multiple neighborhoods)
        const housingBlocks = Math.min(3, Math.floor(housingCount / 4));
        const housesPerBlock = Math.floor(housingCount / housingBlocks);
        
        for (let block = 0; block < housingBlocks; block++) {
            const startIdx = Math.floor(index + (block * totalFeatures / housingBlocks));
            for (let i = 0; i < housesPerBlock && (startIdx + i) < sortedFeatures.length; i++) {
                if (sortedFeatures[startIdx + i]) {
                    sortedFeatures[startIdx + i].properties.status = 'housing';
                }
            }
        }
        
        // Fill in remaining housing to reach target
        let housesAssigned = housingBlocks * housesPerBlock;
        while (housesAssigned < housingCount && index < sortedFeatures.length) {
            if (!sortedFeatures[index].properties.status) {
                sortedFeatures[index].properties.status = 'housing';
                housesAssigned++;
            }
            index++;
        }
        
        // Commercial zones (create multiple smaller commercial centers)
        const commercialCenters = Math.min(3, Math.floor(commercialCount / 2));
        const storesPerCenter = Math.floor(commercialCount / commercialCenters);
        
        for (let center = 0; center < commercialCenters; center++) {
            // Position commercial centers relative to housing zones
            const startPosition = Math.floor((center + 1) * totalFeatures / (commercialCenters + 1));
            let commercialAssigned = 0;
            
            // Create a small cluster of commercial properties
            for (let i = 0; i < storesPerCenter && (startPosition + i) < sortedFeatures.length; i++) {
                if (sortedFeatures[startPosition + i] && !sortedFeatures[startPosition + i].properties.status) {
                    sortedFeatures[startPosition + i].properties.status = 'commercial';
                    commercialAssigned++;
                }
            }
        }
        
        // Schools placed strategically near housing but not all in the same area
        let schoolsAssigned = 0;
        for (let i = 0; i < schoolCount; i++) {
            const position = Math.floor((i + 1) * totalFeatures / (schoolCount + 1));
            if (position < sortedFeatures.length && !sortedFeatures[position].properties.status) {
                sortedFeatures[position].properties.status = 'primary-school';
                schoolsAssigned++;
            }
        }
        
        // GP practices also strategically placed
        let gpsAssigned = 0;
        for (let i = 0; i < gpCount; i++) {
            const position = Math.floor((i + 0.5) * totalFeatures / (gpCount + 1));
            if (position < sortedFeatures.length && !sortedFeatures[position].properties.status) {
                sortedFeatures[position].properties.status = 'gp-practice';
                gpsAssigned++;
            }
        }
        
        // Fill any remaining unassigned features with housing or commercial to ensure complete coverage
        for (let i = 0; i < sortedFeatures.length; i++) {
            if (!sortedFeatures[i].properties.status) {
                if (Math.random() < 0.8) { // 80% chance of housing for remaining areas
                    sortedFeatures[i].properties.status = 'housing';
                } else {
                    sortedFeatures[i].properties.status = 'commercial';
                }
            }
        }
    }
    
    // Helper function to get geographic bounds of features
    function getBounds(features) {
        let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
        
        features.forEach(feature => {
            const coords = feature.geometry.coordinates[0]; // First polygon ring
            coords.forEach(coord => {
                minX = Math.min(minX, coord[0]);
                minY = Math.min(minY, coord[1]);
                maxX = Math.max(maxX, coord[0]);
                maxY = Math.max(maxY, coord[1]);
            });
        });
        
        return { minX, minY, maxX, maxY };
    }
    
    // Helper function to get center of a feature
    function getFeatureCenter(feature) {
        const coords = feature.geometry.coordinates[0]; // First polygon ring
        let sumX = 0, sumY = 0;
        
        coords.forEach(coord => {
            sumX += coord[0];
            sumY += coord[1];
        });
        
        return {
            x: sumX / coords.length,
            y: sumY / coords.length
        };
    }
    
    // Sort features based on their position (different sort for each region)
    function sortFeaturesByPosition(features, regionIndex) {
        return features.sort((a, b) => {
            const centerA = getFeatureCenter(a);
            const centerB = getFeatureCenter(b);
            
            // Different sorting strategies for each region to create varied patterns
            switch (regionIndex) {
                case 0: // Top left: sort by X then Y
                    return centerA.x - centerB.x || centerA.y - centerB.y;
                case 1: // Top right: sort by Y then X
                    return centerA.y - centerB.y || centerA.x - centerB.x;
                case 2: // Bottom left: sort by distance from corner
                    const distA = Math.sqrt(Math.pow(centerA.x, 2) + Math.pow(centerA.y, 2));
                    const distB = Math.sqrt(Math.pow(centerB.x, 2) + Math.pow(centerB.y, 2));
                    return distA - distB;
                case 3: // Bottom right: sort by alternating X and Y bands
                    const bandA = Math.floor(centerA.y * 5) % 2 === 0 ? 
                        centerA.x : -centerA.x;
                    const bandB = Math.floor(centerB.y * 5) % 2 === 0 ? 
                        centerB.x : -centerB.x;
                    return bandA - bandB;
                default:
                    return 0;
            }
        });
    }
    
    // Close the modal if user clicks outside the content area
    window.addEventListener('click', function(event) {
        const feedbackModal = document.getElementById('ai-feedback-modal');
        const suggestionModal = document.getElementById('ai-suggestion-modal');
        
        if (event.target === feedbackModal) {
            closeAiFeedback();
        } else if (event.target === suggestionModal) {
            closeAiSuggestion();
        }
    });
    
    // --- Original Local Plan functions ---
    function showOriginalPlan() {
        // Display the original plan modal
        const modal = document.getElementById('original-plan-modal');
        modal.style.display = 'flex';
    }
    
    function closeOriginalPlan() {
        document.getElementById('original-plan-modal').style.display = 'none';
    }
    
    // Store a backup of the initial grid state when the page first loads
    let initialGridState = null;
    
    // Store the initial state after grid data is loaded
    const originalStoreGridState = function() {
        if (gridData && !initialGridState) {
            initialGridState = JSON.parse(JSON.stringify(gridData));
            console.log('Original plan state saved');
        }
    };
    
    // Apply the original planner's local plan
    function applyOriginalPlan() {
        if (!initialGridState) {
            alert('Original plan data is not available');
            return;
        }
        
        // Restore the grid data to its initial state
        gridData = JSON.parse(JSON.stringify(initialGridState));
        
        // Update the map with the original plan
        updateGridLayer(false);
        updateHousesCount();
        
        // Show a message in the modal about applying the plan
        const buttons = document.querySelector('#original-plan-modal .govuk-!-margin-top-6');
        buttons.innerHTML = '<p class="govuk-body govuk-!-font-weight-bold">Original plan restored successfully!</p>';
        
        // Close the modal after a delay
        setTimeout(() => {
            closeOriginalPlan();
        }, 2000);
    }
    
    // Close modals if user clicks outside content areas
    window.addEventListener('click', function(event) {
        const feedbackModal = document.getElementById('ai-feedback-modal');
        const suggestionModal = document.getElementById('ai-suggestion-modal');
        const originalPlanModal = document.getElementById('original-plan-modal');
        
        if (event.target === feedbackModal) {
            closeAiFeedback();
        } else if (event.target === suggestionModal) {
            closeAiSuggestion();
        } else if (event.target === originalPlanModal) {
            closeOriginalPlan();
        }
    });
    
    // Close with escape key
    window.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            closeAiFeedback();
            closeAiSuggestion();
            closeOriginalPlan();
        }
    });
    
    // Store the original plan state when grid data is first loaded
    document.addEventListener('DOMContentLoaded', function() {
        // Add a hook to store the original state once grid data is loaded
        const originalLoadGridData = window.loadGridData;
        window.loadGridData = function(data) {
            originalLoadGridData(data);
            originalStoreGridState();
        };
    });
  </script>
</body>
</html>
