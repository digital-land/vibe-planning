<!DOCTYPE html>
<html lang="en" class="govuk-template">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Vibe planning - GOV.UK</title>
    
    <!-- Base URL script to handle both local and GitHub Pages environments -->
    <script>
        // Determine the base URL for assets
        (function() {
            // This function sets a global baseUrl variable that can be used throughout the application
            window.baseUrl = '';
            
            // Get the current path
            var path = window.location.pathname;
            
            // Check if we're on GitHub Pages (or any non-root deployment)
            // Extract the base part of the path (everything before the last directory)
            var pathParts = path.split('/');
            if (pathParts.length > 2) {
                // Remove the last part (assuming it's index.html or empty)
                pathParts.pop();
                // Join the remaining parts to form the base URL
                window.baseUrl = pathParts.join('/');
                // If we're at the root of a directory, baseUrl might end up empty
                if (window.baseUrl === '') {
                    window.baseUrl = '/';
                } else if (!window.baseUrl.endsWith('/')) {
                    window.baseUrl += '/';
                }
            } else {
                window.baseUrl = '/';
            }
            
            console.log('Base URL detected:', window.baseUrl);
        })();
    </script>
    
    <!-- GOV.UK Design System -->
    <link rel="shortcut icon" href="assets/govuk/assets/images/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="assets/govuk/govuk-frontend.min.css">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    
    <style>
        body {
            margin: 0;
            padding: 0;
            /* Using GOV.UK font family instead */
        }
        
        #map-container {
            position: relative;
            width: 100vw;
            height: 600px;
            margin-left: calc(-50vw + 50%);
            margin-right: calc(-50vw + 50%);
            margin-bottom: 30px;
            margin-top: 30px;
        }
        
        #map {
            position: absolute;
            width: 100%;
            height: 100%;
            left: 0;
            top: 0;
        }
        
        .control-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background-color: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            max-width: 250px;
        }
        
        .control-title {
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .control-item {
            margin-bottom: 15px;
        }
        
        .color-picker {
            width: 40px;
            height: 25px;
            padding: 0;
            border: none;
            margin-left: 5px;
            vertical-align: middle;
        }
        
        label {
            display: inline-block;
            margin-bottom: 5px;
        }
        
        input[type="range"] {
            width: 100%;
        }
        
        .coverage-value {
            font-weight: bold;
        }
        
        .file-input {
            margin-bottom: 10px;
        }
        
        button {
            padding: 10px 15px;
            background-color: #00703c;
            color: white;
            border: none;
            border-radius: 0;
            cursor: pointer;
            margin-top: 5px;
            font-family: "GDS Transport", arial, sans-serif;
            font-weight: 400;
            font-size: 16px;
            line-height: 1.1875;
            box-shadow: 0 2px 0 #002d18;
            text-align: center;
        }
        
        button:hover {
            background-color: #005a30;
        }
        
        .legend {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid #ddd;
        }
        
        .legend-item {
            margin-bottom: 5px;
        }
        
        .legend-color {
            display: inline-block;
            width: 15px;
            height: 15px;
            margin-right: 5px;
            vertical-align: middle;
        }
        
        /* GOV.UK style for leaflet popups */
        .leaflet-popup-content-wrapper {
            border-radius: 0;
            padding: 0;
            box-shadow: 0 5px 10px rgba(0,0,0,.1);
        }
        
        .leaflet-popup-content {
            margin: 0;
            padding: 15px;
            font-family: "GDS Transport", arial, sans-serif;
            font-size: 16px;
            line-height: 1.5;
        }
        
        .leaflet-popup-content table {
            border-collapse: collapse;
            width: 100%;
        }
        
        .leaflet-popup-content th {
            text-align: left;
            font-weight: 700;
            padding: 5px 10px 5px 0;
            vertical-align: top;
            width: 40%;
        }
        
        .leaflet-popup-content td {
            padding: 5px 0;
            vertical-align: top;
        }
        
        .leaflet-popup-tip {
            background: #00703c;
        }
        
        /* Animation styles */
        @keyframes pulse {
            0% { transform: scale(1); background-color: transparent; }
            25% { transform: scale(1.4); background-color: #ffdd00; }
            50% { transform: scale(1.6); background-color: #ffdd00; }
            75% { transform: scale(1.4); background-color: #ffdd00; }
            100% { transform: scale(1); background-color: transparent; }
        }
        
        .pulse {
            animation: pulse 1s ease-in-out;
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: bold;
        }
        
        /* House count achievement styles */
        .goal-achieved {
            background-color: #ffdd00 !important; /* GOV.UK yellow */
            color: #0b0c0c !important; /* GOV.UK black */
            font-weight: bold;
            padding: 3px 8px;
            border-radius: 4px;
            box-shadow: 0 0 0 3px #ffdd00;
            transition: all 0.3s ease;
        }
        
        /* Goal celebration */
        #celebration-banner {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background-color: #00703c;
            color: white;
            text-align: center;
            padding: 15px;
            z-index: 9999;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            transition: transform 0.5s ease-in-out;
            transform: translateY(-100%);
        }
        
        #celebration-banner.show {
            display: block;
            transform: translateY(0);
        }
        
        #confetti-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9998;
        }
    </style>
</head>
<body class="govuk-template__body">
    <script>document.body.className = ((document.body.className) ? document.body.className + ' js-enabled' : 'js-enabled');</script>
    
    <!-- Celebration elements -->
    <div id="celebration-banner" role="alert">
        <h2 class="govuk-heading-m govuk-!-margin-bottom-1">Goal Achieved!</h2>
        <p class="govuk-body">You've successfully planned 100 houses. Well done!</p>
    </div>
    <canvas id="confetti-canvas"></canvas>

    <a href="#main-content" class="govuk-skip-link">Skip to main content</a>

    <header class="govuk-header" role="banner" data-module="govuk-header">
        <div class="govuk-header__container govuk-width-container">
            <div class="govuk-header__logo">
                <a href="https://www.gov.uk/" class="govuk-header__link govuk-header__link--homepage">
                    <span class="govuk-header__logotype">
                        <svg aria-hidden="true" focusable="false" class="govuk-header__logotype-crown" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 30" height="30" width="32">
                            <path fill="currentColor" fill-rule="evenodd" d="M22.6 10.4c-1 .4-2-.1-2.4-1-.4-.9.1-2 1-2.4.9-.4 2 .1 2.4 1s-.1 2-1 2.4m-5.9 6.7c-.9.4-2-.1-2.4-1-.4-.9.1-2 1-2.4.9-.4 2 .1 2.4 1s-.1 2-1 2.4m10.8-3.7c-1 .4-2-.1-2.4-1-.4-.9.1-2 1-2.4.9-.4 2 .1 2.4 1s-.2 2-1 2.4m3.3 4.8c-1 .4-2-.1-2.4-1-.4-.9.1-2 1-2.4.9-.4 2 .1 2.4 1s-.2 2-1 2.4M17 4.7l2.3 1.2V2.5l-2.3.7-.2-.2.9-3h-3.4l.9 3-.2.2c-.1.1-2.3-.7-2.3-.7v3.4L15 4.7c.1.1.1.2.2.2l-1.3 4c-.1.2-.1.4-.1.6 0 1.1.8 2 1.9 2.2h.7c1-.2 1.9-1.1 1.9-2.1 0-.2 0-.4-.1-.6l-1.3-4c-.1-.2 0-.2.1-.3m-7.6 5.7c.9.4 2-.1 2.4-1 .4-.9-.1-2-1-2.4-.9-.4-2 .1-2.4 1s.1 2 1 2.4m-5 3c.9.4 2-.1 2.4-1 .4-.9-.1-2-1-2.4-.9-.4-2 .1-2.4 1s.1 2 1 2.4m-3.2 4.8c.9.4 2-.1 2.4-1 .4-.9-.1-2-1-2.4-.9-.4-2 .1-2.4 1s.1 2 1 2.4m14.8 11c4.4 0 8.6.3 12.3.8 1.1-4.5 2.4-7 3.7-8.8l-2.5-.9c.2 1.3.3 1.9 0 2.7-.4-.4-.8-1.1-1.1-2.3l-1.2 4c.7-.5 1.3-.8 2-.9-1.1 2.5-2.6 3.1-3.5 3-1.1-.2-1.7-1.2-1.5-2.1.3-1.2 1.5-1.5 2.1-.1 1.1-2.3-.8-3-2-2.3 1.9-1.9 2.1-3.5.6-5.6-2.1 1.6-2.1 3.2-1.2 5.5-1.2-1.4-3.2-.6-2.5 1.6.9-1.4 2.1-.5 1.9.8-.2 1.1-1.7 2.1-3.5 1.9-2.7-.2-2.9-2.1-2.9-3.6.7-.1 1.9.5 2.9 1.9l.4-4.3c-1.1 1.1-2.1 1.4-3.2 1.4.4-1.2 2.1-3 2.1-3h-5.4s1.7 1.9 2.1 3c-1.1 0-2.1-.2-3.2-1.4l.4 4.3c1-1.4 2.2-2 2.9-1.9-.1 1.5-.2 3.4-2.9 3.6-1.9.2-3.4-.8-3.5-1.9-.2-1.3 1-2.2 1.9-.8.7-2.3-1.2-3-2.5-1.6.9-2.2.9-3.9-1.2-5.5-1.5 2-1.3 3.7.6 5.6-1.2-.7-3.1.1-2 2.3.6-1.4 1.8-1.1 2.1.1.2.9-.3 1.9-1.5 2.1-.9.2-2.4-.5-3.5-3 .6.1 1.3.4 2 .9l-1.2-4c-.3 1.1-.7 1.9-1.1 2.3-.3-.8-.2-1.4 0-2.7l-2.5.9C.9 25.3 2.2 27.8 3.3 32.3c3.7-.5 7.9-.8 12.3-.8"></path>
                        </svg>
                        <span class="govuk-header__logotype-text">
                            GOV.UK
                        </span>
                    </span>
                </a>
            </div>
            <div class="govuk-header__content">
                <a href="/" class="govuk-header__link govuk-header__service-name">
                    Vibe Planning
                </a>
            </div>
        </div>
    </header>

    <div class="govuk-width-container">
        <main class="govuk-main-wrapper" id="main-content" role="main">
            <h1 class="govuk-heading-xl">Planning Map</h1>
            
            <!-- Goal Section -->
            <div class="govuk-panel govuk-panel--confirmation">
                <h2 class="govuk-panel__title">Goal</h2>
                <div class="govuk-panel__body govuk-!-font-size-27">
                    Build 100 houses
                </div>
                <div class="govuk-panel__body govuk-!-font-size-19">
                    Current progress: <span id="houses-count">0</span> / 100
                </div>
            </div>
            
            <div class="govuk-!-margin-top-6">
            <div class="govuk-width-container">
                <div class="govuk-form-group">
                    <div class="govuk-checkboxes govuk-checkboxes--small">
                        <div class="govuk-checkboxes__item">
                            <input class="govuk-checkboxes__input" id="toggle-green-belt" name="toggle-green-belt" type="checkbox" checked onchange="toggleGreenBelt(this.checked)">
                            <label class="govuk-label govuk-checkboxes__label" for="toggle-green-belt">
                                <strong>Hide Green Belt areas</strong>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="map-container" class="govuk-!-margin-top-4">
            <div id="map"></div>
        </div>

            <!-- Plan submission section -->
            <div class="govuk-width-container govuk-!-margin-top-6 govuk-!-margin-bottom-6">
                <form id="plan-submit-form" class="govuk-form-group" autocomplete="off" style="max-width: 700px; margin: 0 auto;">
                    <h2 class="govuk-heading-m">Explain why you chose this plan</h2>
                    <span class="govuk-hint">Submitting your plan will add it to the list of plans created by the public</span>
                    <textarea class="govuk-textarea" id="plan-explanation" name="plan-explanation" rows="5" style="margin-bottom: 20px;"></textarea>
                    <div class="govuk-button-group">
                        <button type="submit" class="govuk-button">Submit</button>
                        <a href="other-plans.html" class="govuk-button govuk-button--secondary" style="margin-left: 10px;">See other plans</a>
                    </div>
                </form>
            </div>
    
    <!-- Leaflet JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    
            <div class="govuk-grid-row">
                <div class="govuk-grid-column-full">
                    <div class="govuk-inset-text">
                        <h3 class="govuk-heading-m">Interactive Planning Map</h3>
                        <p class="govuk-body">Click on map areas to view detailed information about green belt coverage.</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <footer class="govuk-footer" role="contentinfo">
        <div class="govuk-width-container">
            <div class="govuk-footer__meta">
                <div class="govuk-footer__meta-item govuk-footer__meta-item--grow">
                    <h2 class="govuk-visually-hidden">Support links</h2>
                    <ul class="govuk-footer__inline-list">
                        <li class="govuk-footer__inline-list-item">
                            <a class="govuk-footer__link" href="#">
                                Help
                            </a>
                        </li>
                        <li class="govuk-footer__inline-list-item">
                            <a class="govuk-footer__link" href="#">
                                Privacy
                            </a>
                        </li>
                        <li class="govuk-footer__inline-list-item">
                            <a class="govuk-footer__link" href="#">
                                Cookies
                            </a>
                        </li>
                    </ul>
                    <svg
                        aria-hidden="true"
                        focusable="false"
                        class="govuk-footer__licence-logo"
                        xmlns="http://www.w3.org/2000/svg"
                        viewBox="0 0 483.2 195.7"
                        height="17"
                        width="41"
                    >
                        <path
                            fill="currentColor"
                            d="M421.5 142.8V.1l-50.7 32.3v161.1h112.4v-50.7zm-122.3-9.6A47.12 47.12 0 0 1 221 97.8c0-26 21.1-47.1 47.1-47.1 16.7 0 31.4 8.7 39.7 21.8l42.7-27.2A97.63 97.63 0 0 0 268.1 0c-36.5 0-68.3 20.1-85.1 49.7A98 98 0 0 0 97.8 0C43.9 0 0 43.9 0 97.8s43.9 97.8 97.8 97.8c36.5 0 68.3-20.1 85.1-49.7a97.76 97.76 0 0 0 149.6 25.4l19.4 22.2h3v-87.8h-80l24.3 27.5zM97.8 145c-26 0-47.1-21.1-47.1-47.1s21.1-47.1 47.1-47.1 47.2 21 47.2 47S123.8 145 97.8 145"
                        ></path>
                    </svg>
                    <span class="govuk-footer__licence-description">
                        All content is available under the
                        <a
                            class="govuk-footer__link"
                            href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/"
                            rel="license"
                        >Open Government Licence v3.0</a>, except where otherwise stated
                    </span>
                </div>
                <div class="govuk-footer__meta-item">
                    <a
                        class="govuk-footer__link govuk-footer__copyright-logo"
                        href="https://www.nationalarchives.gov.uk/information-management/re-using-public-sector-information/uk-government-licensing-framework/crown-copyright/"
                    > Crown copyright</a>
                </div>
            </div>
        </div>
    </footer>

    <!-- GOV.UK JavaScript -->
    <script src="/assets/govuk/govuk-frontend.min.js"></script>
    <script>
        window.GOVUKFrontend.initAll();
    </script>
    
    <!-- Leaflet JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    
    <script>
        // Initialize the map with doubleClickZoom disabled
        const map = L.map('map', {
            doubleClickZoom: false // Disable double click zoom completely
        }).setView([0, 0], 2);
        
        // Add base layers
        const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: ' OpenStreetMap contributors'
        }).addTo(map);
        
        const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            maxZoom: 19,
            attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
        });
        
        // Add layer control
        const baseLayers = {
            "OpenStreetMap": osm,
            "Satellite": satellite
        };
        
        L.control.layers(baseLayers).addTo(map);
        
        // Initialize variables
        let gridLayer = null;
        let gridData = null;
        let highlightEnabled = true;
        let hideGreenBelt = true; // Default to hiding green belt
        
        // Get DOM elements
        const thresholdSlider = document.getElementById('coverage-threshold');
        const thresholdValue = document.getElementById('threshold-value');
        const highlightColorPicker = document.getElementById('highlight-color');
        const defaultColorPicker = document.getElementById('default-color');
        const toggleButton = document.getElementById('toggle-highlight');
        const fileInput = document.getElementById('geojson-file');
        
        // Helper to get fill color by status
        function getFillColor(status) {
            switch(status) {
                case 'green-belt': return "#00703c";
                case 'non-green-belt': return "#ffdd00"; // Changed to GOV.UK yellow for better visibility
                case 'housing': return "#1d70b8";
                case 'commercial': return "#942514";
                default: return "#ffdd00"; // Default also changed to match non-green-belt
            }
        }
        // Function to style GeoJSON features
        function styleFeature(feature) {
            // Hide green belt areas if toggle is active
            if (hideGreenBelt && feature.properties.status === 'green-belt') {
                return {
                    fillOpacity: 0,
                    opacity: 0,
                    interactive: false // Make these squares non-interactive
                };
            }
            
            // Highlight if selected
            if (selectedFeatureIds && selectedFeatureIds.includes(feature.properties.id)) {
                return {
                    weight: 2,
                    color: '#ffdd00', // Yellow border
                    fillOpacity: 0.9,
                    fillColor: getFillColor(feature.properties.status),
                    opacity: 1
                };
            }
            // Using GOV.UK color palette
            const style = {
                weight: 0.5, // Thinner border for subtlety
                opacity: 0.3, // Lower opacity for subtle borders
                color: '#505a5f', // GOV.UK dark grey for subtle borders
                fillOpacity: 0.7
            };
            
            // Initialize status if it doesn't exist yet
            if (!feature.properties.status) {
                // Set default status based on green-belt value
                if (feature.properties["green-belt"] >= 0.1) {
                    feature.properties.status = 'green-belt';
                } else {
                    feature.properties.status = 'non-green-belt';
                }
            }
            
            // Set color based on status
            switch(feature.properties.status) {
                case 'green-belt':
                    style.fillColor = "#00703c"; // GOV.UK green
                    break;
                case 'non-green-belt':
                    style.fillColor = "#ffdd00"; // GOV.UK yellow - better visibility
                    style.fillOpacity = 0.5; // Slightly transparent to indicate it can be modified
                    break;
                case 'housing':
                    style.fillColor = "#1d70b8"; // GOV.UK blue
                    break;
                case 'commercial':
                    style.fillColor = "#942514"; // GOV.UK red
                    break;
                default:
                    style.fillColor = "#f3f2f1"; // Default to light grey
            }
            
            return style;
        }
        
        // Function to add popup information with controls to change land status
        // --- Prevent any zoom-related actions when shift is held ---
        map.on('dblclick', function(e) {
            if (isShiftDown) {
                e.originalEvent.preventDefault();
                e.originalEvent.stopPropagation();
            }
        });
        
        // Also prevent zoom on single click when shift is down
        map.on('click', function(e) {
            if (isShiftDown) {
                e.originalEvent.preventDefault();
                e.originalEvent.stopPropagation();
                return false;
            }
        });
        function onEachFeature(feature, layer) {
            // Prevent zoom on feature double-click
            layer.on('dblclick', function(e) {
                e.originalEvent.preventDefault();
            });
            // Multi-select with shift+click
            layer.on('click', function(e) {
                if (isShiftDown) {
                    // Prevent zoom behavior when shift is held
                    e.originalEvent.preventDefault();
                    e.originalEvent.stopPropagation();
                    // Toggle selection
                    if (!selectedFeatureIds.includes(feature.properties.id)) {
                        selectedFeatureIds.push(feature.properties.id);
                    } else {
                        selectedFeatureIds = selectedFeatureIds.filter(id => id !== feature.properties.id);
                    }
                    updateGridLayer(true); // This is a selection update
                    // Show mass update button if >0
                    if (selectedFeatureIds.length > 0) {
                        massUpdateBtn.style.display = 'block';
                    } else {
                        massUpdateBtn.style.display = 'none';
                    }
                    return;
                } else {
                    // Clear selection if not shift
                    selectedFeatureIds = [];
                    massUpdateBtn.style.display = 'none';
                    updateGridLayer(true); // This is a selection update

                    // --- Popup logic (single click, not shift) ---
                    if (feature.properties) {
                        // Initialize status if it doesn't exist yet
                        if (!feature.properties.status) {
                            // Set default status based on green-belt value
                            if (feature.properties["green-belt"] >= 0.1) {
                                feature.properties.status = 'green-belt';
                            } else {
                                feature.properties.status = 'non-green-belt';
                            }
                        }
                        let popupContent = '<div class="govuk-form-group">';
                        popupContent += '<table class="govuk-table">';
                        popupContent += '<tbody class="govuk-table__body">';
                        // Show ID and coordinates
                        popupContent += `<tr class="govuk-table__row"><th class="govuk-table__header">ID:</th><td class="govuk-table__cell">${feature.properties.id}</td></tr>`;
                        // Current status
                        popupContent += `<tr class="govuk-table__row"><th class="govuk-table__header">Current Status:</th><td class="govuk-table__cell">${formatStatus(feature.properties.status)}</td></tr>`;
                        popupContent += '</tbody></table>';
                        // Add status change controls
                        popupContent += '<fieldset class="govuk-fieldset">';
                        popupContent += '<legend class="govuk-fieldset__legend">Change status to:</legend>';
                        popupContent += '<div class="govuk-radios govuk-radios--small">';
                        // Radio buttons for each possible status
                        const statuses = [
                            {value: 'green-belt', label: 'Green Belt', color: '#00703c'},
                            {value: 'non-green-belt', label: 'Non-Green Belt', color: '#ffdd00'},
                            {value: 'housing', label: 'Housing', color: '#1d70b8'},
                            {value: 'commercial', label: 'Commercial', color: '#942514'}
                        ];
                        statuses.forEach((status, index) => {
                            popupContent += `
                            <div class="govuk-radios__item">
                                <input class="govuk-radios__input" id="status-${feature.properties.id}-${index}" 
                                    name="status-${feature.properties.id}" type="radio" value="${status.value}" 
                                    ${feature.properties.status === status.value ? 'checked' : ''}>
                                <label class="govuk-label govuk-radios__label" for="status-${feature.properties.id}-${index}">
                                    <span style="background-color:${status.color};width:12px;height:12px;display:inline-block;margin-right:5px;"></span>
                                    ${status.label}
                                </label>
                            </div>`;
                        });
                        popupContent += '</div>';
                        popupContent += '</fieldset>';
                        // Add update button
                        popupContent += `<button class="govuk-button govuk-button--secondary govuk-!-margin-top-3" 
                            data-module="govuk-button" onclick="updateStatus(${feature.properties.id})">
                            Update
                        </button>`;
                        popupContent += '</div>';
                        const popup = L.popup()
                            .setLatLng(layer.getBounds().getCenter())
                            .setContent(popupContent)
                            .openOn(map);
                    }
                }

                    // Initialize status if it doesn't exist yet
                    if (!feature.properties.status) {
                        // Set default status based on green-belt value
                        if (feature.properties["green-belt"] >= 0.1) {
                            feature.properties.status = 'green-belt';
                        } else {
                            feature.properties.status = 'non-green-belt';
                        }
                    }
                    
                    let popupContent = '<div class="govuk-form-group">'
                    popupContent += '<table class="govuk-table">';
                    popupContent += '<tbody class="govuk-table__body">';
                    
                    // Show ID and coordinates
                    popupContent += `<tr class="govuk-table__row"><th class="govuk-table__header">ID:</th><td class="govuk-table__cell">${feature.properties.id}</td></tr>`;
                    
                    // Current status
                    popupContent += `<tr class="govuk-table__row"><th class="govuk-table__header">Current Status:</th><td class="govuk-table__cell">${formatStatus(feature.properties.status)}</td></tr>`;
                    
                    popupContent += '</tbody></table>';
                    
                    // Add status change controls
                    popupContent += '<fieldset class="govuk-fieldset">';
                    popupContent += '<legend class="govuk-fieldset__legend">Change status to:</legend>';
                    popupContent += '<div class="govuk-radios govuk-radios--small">';
                    
                    // Radio buttons for each possible status
                    const statuses = [
                        {value: 'green-belt', label: 'Green Belt', color: '#00703c'},
                        {value: 'non-green-belt', label: 'Non-Green Belt', color: '#ffdd00'},
                        {value: 'housing', label: 'Housing', color: '#1d70b8'},
                        {value: 'commercial', label: 'Commercial', color: '#942514'}
                    ];
                    
                    statuses.forEach((status, index) => {
                        popupContent += `
                        <div class="govuk-radios__item">
                            <input class="govuk-radios__input" id="status-${feature.properties.id}-${index}" 
                                name="status-${feature.properties.id}" type="radio" value="${status.value}" 
                                ${feature.properties.status === status.value ? 'checked' : ''}>
                            <label class="govuk-label govuk-radios__label" for="status-${feature.properties.id}-${index}">
                                <span style="background-color:${status.color};width:12px;height:12px;display:inline-block;margin-right:5px;"></span>
                                ${status.label}
                            </label>
                        </div>`;
                    });
                    
                    popupContent += '</div>';
                    popupContent += '</fieldset>';
                    
                    // Add update button
                    popupContent += `<button class="govuk-button govuk-button--secondary govuk-!-margin-top-3" 
                        data-module="govuk-button" onclick="updateStatus(${feature.properties.id})">
                        Update
                    </button>`;
                    
                    popupContent += '</div>';
                    
                    const popup = L.popup()
                        .setLatLng(layer.getBounds().getCenter())
                        .setContent(popupContent)
                        .openOn(map);
                });
        }

        // Helper function to format status for display
        function formatStatus(status) {
            switch(status) {
                case 'green-belt': return 'Green Belt';
                case 'non-green-belt': return 'Non-Green Belt';
                case 'housing': return 'Housing';
                case 'commercial': return 'Commercial';
                default: return status;
            }
        }

        // Function to update the status when the user clicks the Update button
        function updateStatus(featureId) {
            // Find the selected radio button
            const selectedRadio = document.querySelector(`input[name="status-${featureId}"]:checked`);
            
            if (selectedRadio) {
                const newStatus = selectedRadio.value;
                
                // Find the feature in the gridData
                const feature = gridData.features.find(f => f.properties.id === featureId);
                
                if (feature) {
                    // Update the feature's status
                    feature.properties.status = newStatus;
                    
                    // Update the map
                    updateGridLayer(true); // This is a selection update
                    
                    // Update the houses count
                    updateHousesCount();
                    
                    // Close the popup
                    map.closePopup();
                }
            }
        }
        
        // Function to count and update the number of housing units with animation
        function updateHousesCount() {
            // Each grid square designated as housing counts as 10 houses
            const housesPerSquare = 10;
            
            // Count housing squares
            const housingSquares = gridData.features.filter(feature => 
                feature.properties.status === 'housing'
            ).length;
            
            // Calculate total houses
            const totalHouses = housingSquares * housesPerSquare;
            
            // Get current displayed value
            const housesCountElement = document.getElementById('houses-count');
            const currentValue = parseInt(housesCountElement.textContent, 10) || 0;
            
            // If value has changed, animate the counter
            if (currentValue !== totalHouses) {
                // Make counter more visually noticeable by applying pulse before starting animation
                housesCountElement.classList.add('pulse');
                
                // A brief pause to ensure the pulse is noticed
                setTimeout(() => {
                    // Animate counter
                    animateCounter(currentValue, totalHouses, housesCountElement);
                    
                    // Remove pulse after animation completes
                    setTimeout(() => {
                        housesCountElement.classList.remove('pulse');
                    }, 1000);
                    
                    // Check if goal is newly met (crossing the threshold)
                    if (currentValue < 100 && totalHouses >= 100) {
                        celebrateGoalAchieved();
                    }
                }, 100);
            }
            
            // Update styling based on goal status
            if (totalHouses >= 100) {
                housesCountElement.classList.add('goal-achieved');
            } else {
                housesCountElement.classList.remove('goal-achieved');
            }
        }
        
        // Animate counter from start to end value
        function animateCounter(start, end, element) {
            const duration = 1000; // 1 second animation
            const stepTime = 20;
            const steps = duration / stepTime;
            const increment = (end - start) / steps;
            let current = start;
            let step = 0;
            
            const timer = setInterval(() => {
                step++;
                current += increment;
                
                if (step >= steps) {
                    clearInterval(timer);
                    current = end;
                }
                
                element.textContent = Math.round(current);
            }, stepTime);
        }
        
        // Celebration when goal is achieved
        function celebrateGoalAchieved() {
            // Show the celebration banner with animation
            const banner = document.getElementById('celebration-banner');
            banner.classList.add('show');
            
            // Hide after 5 seconds
            setTimeout(() => {
                banner.classList.remove('show');
            }, 5000);
            
            // Launch confetti
            launchConfetti();
        }
        
        // Confetti animation for celebration
        function launchConfetti() {
            const canvas = document.getElementById('confetti-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            
            // Confetti colors - GOV.UK colors
            const colors = ['#00703c', '#1d70b8', '#f3f2f1', '#ffdd00'];
            
            // Confetti particles
            const confetti = [];
            const confettiCount = 200;
            const gravity = 0.5;
            const terminalVelocity = 5;
            const drag = 0.075;
            
            // Create confetti pieces
            for (let i = 0; i < confettiCount; i++) {
                // Distribute confetti across the top of the screen
                confetti.push({
                    color: colors[Math.floor(Math.random() * colors.length)],
                    dimensions: {
                        x: Math.random() * 10 + 5,
                        y: Math.random() * 4 + 8
                    },
                    position: {
                        x: Math.random() * canvas.width,
                        // Distribute starting positions across the top quarter of the screen
                        y: Math.random() * canvas.height * -0.25
                    },
                    rotation: Math.random() * 2 * Math.PI,
                    scale: Math.random() * 0.8 + 0.2, // More varied sizes
                    velocity: {
                        x: Math.random() * 25 - 12.5,
                        y: Math.random() * 25 + 10 // Higher velocity variation for spreading
                    }
                });
            }
            
            // Animation loop
            let animationFrame = null;
            const render = () => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                let remainingConfetti = 0;
                
                confetti.forEach((confetto, index) => {
                    let width = confetto.dimensions.x * confetto.scale;
                    let height = confetto.dimensions.y * confetto.scale;
                    
                    // Move confetti with gravity and drag
                    confetto.velocity.x -= confetto.velocity.x * drag;
                    confetto.velocity.y = Math.min(confetto.velocity.y + gravity, terminalVelocity);
                    confetto.velocity.x += Math.random() > 0.5 ? Math.random() : -Math.random();
                    
                    confetto.position.x += confetto.velocity.x;
                    confetto.position.y += confetto.velocity.y;
                    confetto.rotation += 0.01;
                    
                    // If confetti is still on screen, render it
                    if (confetto.position.y <= canvas.height) {
                        remainingConfetti++;
                        
                        ctx.save();
                        ctx.translate(confetto.position.x, confetto.position.y);
                        ctx.rotate(confetto.rotation);
                        
                        ctx.fillStyle = confetto.color;
                        ctx.fillRect(-width / 2, -height / 2, width, height);
                        
                        ctx.restore();
                    }
                });
                
                // Continue animation if there's confetti on screen
                if (remainingConfetti > 0) {
                    animationFrame = requestAnimationFrame(render);
                } else {
                    cancelAnimationFrame(animationFrame);
                    // Clean up canvas when done
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                }
            };
            
            // Start animation
            animationFrame = requestAnimationFrame(render);
            
            // Stop confetti after 6 seconds regardless
            setTimeout(() => {
                if (animationFrame) {
                    cancelAnimationFrame(animationFrame);
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                }
            }, 6000);
        }
        
        // Update grid layer
        // Flag to track initial load
        let initialMapLoad = true;
        
        // Function to update the grid layer with current data
        function updateGridLayer(isSelection) {
            if (!gridData) return;
            
            if (gridLayer) {
                map.removeLayer(gridLayer);
            }
            
            // First, prepare a filtered version of the data when hiding green belt
            // This creates a completely new GeoJSON structure without the green belt areas
            let dataToRender = gridData;
            
            if (hideGreenBelt) {
                // Deep clone the data to avoid modifying the original
                dataToRender = JSON.parse(JSON.stringify(gridData));
                // Filter out green belt features entirely
                dataToRender.features = dataToRender.features.filter(feature => 
                    !(feature.properties.status === 'green-belt' || 
                      (feature.properties["green-belt"] >= 0.1 && !feature.properties.status))
                );
            }
            
            gridLayer = L.geoJSON(dataToRender, {
                style: styleFeature,
                onEachFeature: onEachFeature
                // No filter function here - we've already filtered the data
            }).addTo(map);

            // Only fit bounds on initial load (not for selections or updates)
            if (initialMapLoad && !isSelection) {
                map.fitBounds(gridLayer.getBounds());
                initialMapLoad = false;
            }
        }
        
        // Load GeoJSON data from file
        function loadGeoJSONFile(file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    gridData = JSON.parse(e.target.result);
                    updateGridLayer(false); // Not a selection
                    
                    // Zoom to the data
                    if (gridLayer) {
                        map.fitBounds(gridLayer.getBounds());
                    }
                } catch (error) {
                    console.error("Error parsing GeoJSON:", error);
                    alert("Error loading GeoJSON file. Please check the console for details.");
                }
            };
            
            reader.readAsText(file);
        }
        
        // Load the default GeoJSON data
        fetch('grid/E60000070.geojson')
            .then(response => response.json())
            .then(data => {
                gridData = data;
                
                // Initialize the hideGreenBelt flag before first render
                // This ensures the checkbox state matches our hideGreenBelt variable
                hideGreenBelt = document.getElementById('toggle-green-belt').checked;
                
                // Make sure green belt is properly hidden on initial load
                // Force a false parameter to ensure it's not treated as a selection
                updateGridLayer(false);
                
                // Update houses count
                updateHousesCount();
            })
            .catch(error => console.error('Error loading example data:', error));
    </script>
    <!-- Mass Update Modal -->
    <div id="mass-update-modal" class="govuk-modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.5); z-index:20000; align-items:center; justify-content:center;">
      <div style="background:white; padding:32px; border-radius:8px; min-width:320px; max-width:90vw; margin:auto;">
        <h2 class="govuk-heading-m">Update Category for Selected Boxes</h2>
        <form id="mass-update-form">
          <fieldset class="govuk-fieldset">
            <legend class="govuk-fieldset__legend">Set new category:</legend>
            <div class="govuk-radios govuk-radios--small">
              <div class="govuk-radios__item">
                <input class="govuk-radios__input" id="mass-status-green-belt" name="mass-status" type="radio" value="green-belt">
                <label class="govuk-label govuk-radios__label" for="mass-status-green-belt">
                  <span style="background-color:#00703c;width:12px;height:12px;display:inline-block;margin-right:5px;"></span>Green Belt
                </label>
              </div>
              <div class="govuk-radios__item">
                <input class="govuk-radios__input" id="mass-status-non-green-belt" name="mass-status" type="radio" value="non-green-belt">
                <label class="govuk-label govuk-radios__label" for="mass-status-non-green-belt">
                  <span style="background-color:#ffdd00;width:12px;height:12px;display:inline-block;margin-right:5px;"></span>Non-Green Belt
                </label>
              </div>
              <div class="govuk-radios__item">
                <input class="govuk-radios__input" id="mass-status-housing" name="mass-status" type="radio" value="housing">
                <label class="govuk-label govuk-radios__label" for="mass-status-housing">
                  <span style="background-color:#1d70b8;width:12px;height:12px;display:inline-block;margin-right:5px;"></span>Housing
                </label>
              </div>
              <div class="govuk-radios__item">
                <input class="govuk-radios__input" id="mass-status-commercial" name="mass-status" type="radio" value="commercial">
                <label class="govuk-label govuk-radios__label" for="mass-status-commercial">
                  <span style="background-color:#942514;width:12px;height:12px;display:inline-block;margin-right:5px;"></span>Commercial
                </label>
              </div>
            </div>
          </fieldset>
          <div style="margin-top:20px;">
            <button type="submit" class="govuk-button govuk-!-margin-right-2">Update Selected</button>
            <button type="button" class="govuk-button govuk-button--secondary" onclick="closeMassUpdateModal()">Cancel</button>
          </div>
        </form>
      </div>
    </div>

    <script>
    // --- Multi-select state ---
    let selectedFeatureIds = [];
    let isShiftDown = false;

    document.addEventListener('keydown', function(e) {
        if (e.key === 'Shift') {
            isShiftDown = true;
            // Disable zoom when shift is pressed
            map.scrollWheelZoom.disable();
            map.dragging.disable();
            // Also temporarily disable any click zoom
            if (map.options.zoomSnap) {
                map._originalZoomSnap = map.options.zoomSnap;
                map.options.zoomSnap = 0;
            }
        }
    });
    document.addEventListener('keyup', function(e) {
        if (e.key === 'Shift') {
            isShiftDown = false;
            // Re-enable zoom when shift is released
            map.scrollWheelZoom.enable();
            map.dragging.enable();
            // Restore original zoom snap setting
            if (map._originalZoomSnap !== undefined) {
                map.options.zoomSnap = map._originalZoomSnap;
                delete map._originalZoomSnap;
            }
        }
    });

    // --- Add a floating button for mass update ---
    let massUpdateBtn = document.createElement('button');
    massUpdateBtn.innerText = 'Mass Update Category';
    massUpdateBtn.className = 'govuk-button govuk-button--secondary';
    massUpdateBtn.style.position = 'fixed';
    massUpdateBtn.style.bottom = '32px';
    massUpdateBtn.style.right = '32px';
    massUpdateBtn.style.zIndex = 20001;
    massUpdateBtn.style.display = 'none';
    massUpdateBtn.onclick = function() {
        if (selectedFeatureIds.length > 0) openMassUpdateModal();
    };
    document.body.appendChild(massUpdateBtn);

    // --- Modal logic ---
    function openMassUpdateModal() {
        document.getElementById('mass-update-modal').style.display = 'flex';
    }
    function closeMassUpdateModal() {
        document.getElementById('mass-update-modal').style.display = 'none';
        selectedFeatureIds = [];
        updateGridLayer();
        massUpdateBtn.style.display = 'none';
    }
    document.getElementById('mass-update-form').onsubmit = function(e) {
        e.preventDefault();
        const newStatus = document.querySelector('input[name="mass-status"]:checked');
        if (!newStatus) return;
        massUpdateStatus(newStatus.value);
        closeMassUpdateModal();
    };
    // --- Toggle Green Belt function ---
    function toggleGreenBelt(checked) {
        hideGreenBelt = checked;
        updateGridLayer(false); // Not a selection, but a filter change
    }
    
    // --- Mass update function ---
    function massUpdateStatus(newStatus) {
        if (!gridData) return;
        gridData.features.forEach(f => {
            if (selectedFeatureIds.includes(f.properties.id)) {
                f.properties.status = newStatus;
            }
        });
        updateGridLayer(true); // This is a selection update
        if (typeof updateHousesCount === 'function') updateHousesCount();
    }
    </script>
</body>
</html>
